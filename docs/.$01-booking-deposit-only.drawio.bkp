<mxfile host="app.diagrams.net" modified="2025-01-06T00:00:00.000Z" agent="Claude Code" version="24.0.0" type="device">
  <diagram name="Booking with Deposit Payment Flow" id="sequence-diagram">
    <mxGraphModel dx="1434" dy="844" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="2000" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="Booking with Deposit Payment Flow (Deposit Only)&#xa;EV Service Center Management System" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="400" y="20" width="800" height="40" as="geometry" />
        </mxCell>

        <!-- Lifelines -->
        <!-- Customer -->
        <mxCell id="customer-box" value="Customer" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;outlineConnect=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="80" y="100" width="40" height="80" as="geometry" />
        </mxCell>
        <mxCell id="customer-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="100" y="1950" as="sourcePoint" />
            <mxPoint x="100" y="180" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- BookingPage (UI) -->
        <mxCell id="ui-box" value="BookingPage" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="220" y="120" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="ui-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="270" y="1950" as="sourcePoint" />
            <mxPoint x="270" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- AppointmentService -->
        <mxCell id="appsvc-box" value="AppointmentService" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="380" y="120" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="appsvc-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="440" y="1950" as="sourcePoint" />
            <mxPoint x="440" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- VNPayController -->
        <mxCell id="vnpay-box" value="VNPayController" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="560" y="120" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="vnpay-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="620" y="1950" as="sourcePoint" />
            <mxPoint x="620" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- TransactionService -->
        <mxCell id="txsvc-box" value="TransactionService" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="740" y="120" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="txsvc-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="800" y="1950" as="sourcePoint" />
            <mxPoint x="800" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- VNPayGateway -->
        <mxCell id="gateway-box" value="VNPayGateway" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="920" y="120" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="gateway-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="980" y="1950" as="sourcePoint" />
            <mxPoint x="980" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Database -->
        <mxCell id="db-box" value="Database" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1100" y="120" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="db-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1150" y="1950" as="sourcePoint" />
            <mxPoint x="1150" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- EmailService -->
        <mxCell id="email-box" value="EmailService" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1260" y="120" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="email-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1310" y="1950" as="sourcePoint" />
            <mxPoint x="1310" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Use Case Note -->
        <mxCell id="usecase-note" value="Use Case: Customer đặt cọc 200,000 VND để book lịch hẹn (không chọn dịch vụ)&#xa;Pre-condition: Customer đã đăng nhập, có xe trong hệ thống&#xa;Post-condition: Appointment được tạo với status &quot;confirmed&quot;, cọc đã thanh toán&#xa;Note: Dịch vụ cụ thể sẽ xác định sau khi technician kiểm tra xe" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;size=10;" vertex="1" parent="1">
          <mxGeometry x="80" y="220" width="1280" height="60" as="geometry" />
        </mxCell>

        <!-- PHASE 1: Customer điền form booking -->
        <mxCell id="phase1-label" value="PHASE 1: CUSTOMER ĐIỀN FORM BOOKING" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#0066CC;" vertex="1" parent="1">
          <mxGeometry x="80" y="300" width="1280" height="20" as="geometry" />
        </mxCell>

        <!-- Message 1: fillBookingForm -->
        <mxCell id="msg1" value="fillBookingForm()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="100" y="340" as="sourcePoint" />
            <mxPoint x="270" y="340" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for UI (fillBookingForm) -->
        <mxCell id="ui-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="265" y="340" width="10" height="80" as="geometry" />
        </mxCell>

        <!-- Self-call: validateInput -->
        <mxCell id="msg2" value="validateInput()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="0.1" y="10" relative="1" as="geometry">
            <mxPoint x="275" y="360" as="sourcePoint" />
            <mxPoint x="330" y="360" as="targetPoint" />
            <Array as="points">
              <mxPoint x="310" y="360" />
              <mxPoint x="310" y="380" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Validation Note -->
        <mxCell id="validate-note" value="Validate:&#xa;- vehicleId exists&#xa;- scheduledDate valid&#xa;- scheduledTime available&#xa;- bookingType: &quot;deposit_booking&quot;" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="340" y="340" width="180" height="80" as="geometry" />
        </mxCell>

        <!-- Return: showBookingPreview -->
        <mxCell id="msg3" value="showBookingPreview()" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="270" y="410" as="sourcePoint" />
            <mxPoint x="100" y="410" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 4: confirmBooking -->
        <mxCell id="msg4" value="confirmBooking()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="100" y="450" as="sourcePoint" />
            <mxPoint x="270" y="450" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for UI (confirmBooking) -->
        <mxCell id="ui-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="265" y="450" width="10" height="400" as="geometry" />
        </mxCell>

        <!-- PHASE 2: Tạo Payment URL -->
        <mxCell id="phase2-label" value="PHASE 2: TẠO PAYMENT URL" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#0066CC;" vertex="1" parent="1">
          <mxGeometry x="80" y="480" width="1280" height="20" as="geometry" />
        </mxCell>

        <!-- Message 5: POST /api/vnpay/create-payment -->
        <mxCell id="msg5" value="POST /api/vnpay/create-payment" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="275" y="520" as="sourcePoint" />
            <mxPoint x="620" y="520" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for VNPay -->
        <mxCell id="vnpay-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="615" y="520" width="10" height="220" as="geometry" />
        </mxCell>

        <!-- VNPay Request Note -->
        <mxCell id="vnpay-req-note" value="Request body:&#xa;- amount: 200000&#xa;- orderInfo: &quot;Thanh toan dat coc xe dien&quot;&#xa;- paymentType: &quot;deposit&quot;&#xa;- appointmentData: {&#xa;    vehicleId, scheduledDate,&#xa;    scheduledTime}" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="650" y="520" width="200" height="100" as="geometry" />
        </mxCell>

        <!-- Message 6: createTransaction -->
        <mxCell id="msg6" value="createTransaction(vnpay, data)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="625" y="560" as="sourcePoint" />
            <mxPoint x="800" y="560" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for TxSvc -->
        <mxCell id="txsvc-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="795" y="560" width="10" height="100" as="geometry" />
        </mxCell>

        <!-- Message 7: INSERT Transaction -->
        <mxCell id="msg7" value="INSERT Transaction" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="805" y="580" as="sourcePoint" />
            <mxPoint x="1150" y="580" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for DB -->
        <mxCell id="db-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1145" y="580" width="10" height="40" as="geometry" />
        </mxCell>

        <!-- Return: transactionId -->
        <mxCell id="msg8" value="transactionId" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="1150" y="610" as="sourcePoint" />
            <mxPoint x="800" y="610" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Transaction Note -->
        <mxCell id="tx-note" value="Transaction:&#xa;- transactionRef: APP{timestamp}{random}&#xa;- status: &quot;pending&quot;&#xa;- paymentPurpose: &quot;deposit_booking&quot;&#xa;- amount: 200000&#xa;- metadata: {appointmentData}" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="870" y="560" width="220" height="90" as="geometry" />
        </mxCell>

        <!-- Return: Transaction to VNPay -->
        <mxCell id="msg9" value="Transaction" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="800" y="650" as="sourcePoint" />
            <mxPoint x="620" y="650" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Self-call: buildPaymentUrl -->
        <mxCell id="msg10" value="buildPaymentUrl()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="0.1" y="10" relative="1" as="geometry">
            <mxPoint x="625" y="670" as="sourcePoint" />
            <mxPoint x="680" y="670" as="targetPoint" />
            <Array as="points">
              <mxPoint x="660" y="670" />
              <mxPoint x="660" y="690" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- VNPay Params Note -->
        <mxCell id="vnpay-params-note" value="VNPay params:&#xa;- vnp_TxnRef&#xa;- vnp_Amount: 20000000 (VND * 100)&#xa;- vnp_ReturnUrl&#xa;- vnp_SecureHash" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="690" y="660" width="200" height="70" as="geometry" />
        </mxCell>

        <!-- Return: paymentUrl -->
        <mxCell id="msg11" value="{paymentUrl, transactionRef, transactionId}" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="620" y="730" as="sourcePoint" />
            <mxPoint x="270" y="730" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- PHASE 3: Thanh toán tại VNPay -->
        <mxCell id="phase3-label" value="PHASE 3: THANH TOÁN TẠI VNPAY" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#0066CC;" vertex="1" parent="1">
          <mxGeometry x="80" y="760" width="1280" height="20" as="geometry" />
        </mxCell>

        <!-- Message 12: redirect(paymentUrl) -->
        <mxCell id="msg12" value="redirect(paymentUrl)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="275" y="800" as="sourcePoint" />
            <mxPoint x="980" y="800" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for Gateway -->
        <mxCell id="gateway-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="975" y="800" width="10" height="60" as="geometry" />
        </mxCell>

        <!-- Message 13: displayPaymentPage -->
        <mxCell id="msg13" value="displayPaymentPage()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="980" y="820" as="sourcePoint" />
            <mxPoint x="100" y="820" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 14: enterPaymentInfo -->
        <mxCell id="msg14" value="enterPaymentInfo()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="100" y="880" as="sourcePoint" />
            <mxPoint x="980" y="880" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for Gateway (processPayment) -->
        <mxCell id="gateway-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="975" y="880" width="10" height="900" as="geometry" />
        </mxCell>

        <!-- Self-call: processPayment -->
        <mxCell id="msg15" value="processPayment()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="0.1" y="10" relative="1" as="geometry">
            <mxPoint x="985" y="900" as="sourcePoint" />
            <mxPoint x="1040" y="900" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1020" y="900" />
              <mxPoint x="1020" y="920" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- ALT Frame: Payment Success/Failed -->
        <mxCell id="alt-frame" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#6c8ebf;strokeWidth=2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="60" y="940" width="1320" height="980" as="geometry" />
        </mxCell>

        <!-- ALT Label -->
        <mxCell id="alt-label" value="alt" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="65" y="940" width="30" height="20" as="geometry" />
        </mxCell>

        <!-- Condition Success -->
        <mxCell id="alt-cond1" value="[vnp_ResponseCode == &quot;00&quot;] Payment Success" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=2;" vertex="1" parent="1">
          <mxGeometry x="100" y="945" width="300" height="20" as="geometry" />
        </mxCell>

        <!-- SUCCESS FLOW: Messages inside alt frame -->
        
        <!-- Message 16: GET /api/vnpay/return [success] -->
        <mxCell id="msg16" value="GET /api/vnpay/return [vnp_ResponseCode=00]" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="980" y="980" as="sourcePoint" />
            <mxPoint x="620" y="980" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for VNPay (return handler) -->
        <mxCell id="vnpay-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="615" y="980" width="10" height="280" as="geometry" />
        </mxCell>

        <!-- Callback params note -->
        <mxCell id="callback-note" value="Callback params:&#xa;- vnp_TxnRef&#xa;- vnp_ResponseCode: &quot;00&quot;&#xa;- vnp_TransactionNo&#xa;- vnp_Amount&#xa;- vnp_SecureHash" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="420" y="970" width="180" height="80" as="geometry" />
        </mxCell>

        <!-- Self-call: verifyReturnUrl -->
        <mxCell id="msg17" value="verifyReturnUrl()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="0.1" y="10" relative="1" as="geometry">
            <mxPoint x="625" y="1010" as="sourcePoint" />
            <mxPoint x="680" y="1010" as="targetPoint" />
            <Array as="points">
              <mxPoint x="660" y="1010" />
              <mxPoint x="660" y="1030" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 18: SELECT Transaction -->
        <mxCell id="msg18" value="SELECT Transaction WHERE transactionRef = vnp_TxnRef" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="625" y="1050" as="sourcePoint" />
            <mxPoint x="1150" y="1050" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="db-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1145" y="1050" width="10" height="40" as="geometry" />
        </mxCell>

        <!-- Return: Transaction -->
        <mxCell id="msg19" value="Transaction" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="1150" y="1080" as="sourcePoint" />
            <mxPoint x="620" y="1080" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 20: updateTransactionStatus(completed) -->
        <mxCell id="msg20" value="updateTransactionStatus(completed, data)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="625" y="1110" as="sourcePoint" />
            <mxPoint x="800" y="1110" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="txsvc-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="795" y="1110" width="10" height="100" as="geometry" />
        </mxCell>

        <!-- Message 21: UPDATE Transaction status -->
        <mxCell id="msg21" value="UPDATE Transaction SET status = 'completed'" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="805" y="1130" as="sourcePoint" />
            <mxPoint x="1150" y="1130" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="db-act3" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1145" y="1130" width="10" height="40" as="geometry" />
        </mxCell>

        <!-- Update transaction note -->
        <mxCell id="update-tx-note" value="Update:&#xa;- status: 'completed'&#xa;- responseCode: '00'&#xa;- paidAmount: 200000&#xa;- vnpayData: {bankCode, cardType, payDate}" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="870" y="1110" width="220" height="80" as="geometry" />
        </mxCell>

        <!-- Return: OK -->
        <mxCell id="msg22" value="OK" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="1150" y="1160" as="sourcePoint" />
            <mxPoint x="800" y="1160" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Return: Transaction to VNPay -->
        <mxCell id="msg23" value="Transaction" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="800" y="1200" as="sourcePoint" />
            <mxPoint x="620" y="1200" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 24: redirect to client success -->
        <mxCell id="msg24" value="redirect(clientUrl/payment/vnpay-return?success=true)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="620" y="1240" as="sourcePoint" />
            <mxPoint x="980" y="1240" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 25: redirect to UI -->
        <mxCell id="msg25" value="redirect" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="980" y="1270" as="sourcePoint" />
            <mxPoint x="270" y="1270" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="ui-act3" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="265" y="1270" width="10" height="280" as="geometry" />
        </mxCell>

        <!-- Message 26: displayPaymentSuccess -->
        <mxCell id="msg26" value="displayPaymentSuccess()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="270" y="1290" as="sourcePoint" />
            <mxPoint x="100" y="1290" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- PHASE 4 Label -->
        <mxCell id="phase4-label" value="PHASE 4: TẠO APPOINTMENT SAU KHI THANH TOÁN THÀNH CÔNG" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;fontColor=#0066CC;" vertex="1" parent="1">
          <mxGeometry x="100" y="1310" width="1220" height="20" as="geometry" />
        </mxCell>

        <!-- Message 27: POST /api/appointments -->
        <mxCell id="msg27" value="POST /api/appointments" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="275" y="1340" as="sourcePoint" />
            <mxPoint x="440" y="1340" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="appsvc-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="435" y="1340" width="10" height="380" as="geometry" />
        </mxCell>

        <!-- Appointment Request Note -->
        <mxCell id="apt-req-note" value="Request body:&#xa;- vehicleId&#xa;- bookingType: 'deposit_booking'&#xa;- services: [] (empty)&#xa;- scheduledDate, scheduledTime&#xa;- customerNotes (optional)&#xa;- paymentInfo: {transactionRef}" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="100" y="1340" width="200" height="110" as="geometry" />
        </mxCell>

        <!-- Message 28: SELECT Vehicle -->
        <mxCell id="msg28" value="SELECT Vehicle WHERE _id = vehicleId AND customerId = userId" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="445" y="1380" as="sourcePoint" />
            <mxPoint x="1150" y="1380" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="db-act4" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1145" y="1380" width="10" height="40" as="geometry" />
        </mxCell>

        <!-- Return: Vehicle -->
        <mxCell id="msg29" value="Vehicle" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="1150" y="1410" as="sourcePoint" />
            <mxPoint x="440" y="1410" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Self-call: validateVehicleOwnership -->
        <mxCell id="msg30" value="validateVehicleOwnership()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="0.1" y="10" relative="1" as="geometry">
            <mxPoint x="445" y="1430" as="sourcePoint" />
            <mxPoint x="500" y="1430" as="targetPoint" />
            <Array as="points">
              <mxPoint x="480" y="1430" />
              <mxPoint x="480" y="1450" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Self-call: generateAppointmentNumber -->
        <mxCell id="msg31" value="generateAppointmentNumber()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="0.1" y="10" relative="1" as="geometry">
            <mxPoint x="445" y="1470" as="sourcePoint" />
            <mxPoint x="500" y="1470" as="targetPoint" />
            <Array as="points">
              <mxPoint x="480" y="1470" />
              <mxPoint x="480" y="1490" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Appointment Number Note -->
        <mxCell id="apt-num-note" value="appointmentNumber: APT{YYMMDD}{random3digits}&#xa;Example: APT250106234" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="510" y="1460" width="220" height="40" as="geometry" />
        </mxCell>

        <!-- Message 32: INSERT Appointment -->
        <mxCell id="msg32" value="INSERT Appointment" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="445" y="1520" as="sourcePoint" />
            <mxPoint x="1150" y="1520" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="db-act5" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1145" y="1520" width="10" height="80" as="geometry" />
        </mxCell>

        <!-- Appointment Data Note -->
        <mxCell id="apt-data-note" value="Appointment:&#xa;- appointmentNumber: APT250106234&#xa;- customerId, vehicleId&#xa;- services: [] (empty)&#xa;- bookingType: 'deposit_booking'&#xa;- depositInfo: {amount: 200000, paid: true, paidAt: now, transactionId}&#xa;- status: 'confirmed'&#xa;- scheduledDate, scheduledTime&#xa;- customerNotes (optional)" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="750" y="1510" width="340" height="130" as="geometry" />
        </mxCell>

        <!-- Return: appointmentId -->
        <mxCell id="msg33" value="appointmentId" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="1150" y="1590" as="sourcePoint" />
            <mxPoint x="440" y="1590" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 34: updateTransactionAppointmentId -->
        <mxCell id="msg34" value="updateTransactionAppointmentId(transactionRef, appointmentId)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="445" y="1620" as="sourcePoint" />
            <mxPoint x="800" y="1620" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="txsvc-act3" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="795" y="1620" width="10" height="80" as="geometry" />
        </mxCell>

        <!-- Message 35: UPDATE Transaction -->
        <mxCell id="msg35" value="UPDATE Transaction SET appointmentId = appointmentId" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="805" y="1640" as="sourcePoint" />
            <mxPoint x="1150" y="1640" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="db-act6" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1145" y="1640" width="10" height="40" as="geometry" />
        </mxCell>

        <!-- Return: OK -->
        <mxCell id="msg36" value="OK" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="1150" y="1670" as="sourcePoint" />
            <mxPoint x="800" y="1670" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Return: OK to AppSvc -->
        <mxCell id="msg37" value="OK" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="800" y="1690" as="sourcePoint" />
            <mxPoint x="440" y="1690" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- PHASE 5 Label -->
        <mxCell id="phase5-label" value="PHASE 5: GỬI EMAIL XÁC NHẬN" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;fontColor=#0066CC;" vertex="1" parent="1">
          <mxGeometry x="100" y="1540" width="1220" height="20" as="geometry" />
        </mxCell>

        <!-- Par frame for parallel email sending -->
        <mxCell id="par-frame" value="par" style="text;html=1;strokeColor=none;fillColor=#e1d5e7;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="1205" y="1560" width="30" height="20" as="geometry" />
        </mxCell>

        <!-- Message 38: sendAppointmentConfirmation -->
        <mxCell id="msg38" value="sendAppointmentConfirmation(appointmentData, userData)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="445" y="1580" as="sourcePoint" />
            <mxPoint x="1310" y="1580" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="email-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1305" y="1580" width="10" height="60" as="geometry" />
        </mxCell>

        <!-- Email Content Note -->
        <mxCell id="email-note" value="Email content:&#xa;- Appointment number: APT250106234&#xa;- Scheduled date &amp; time&#xa;- Service center info&#xa;- Deposit paid: 200,000 VND&#xa;- Note: Dịch vụ cụ thể sẽ xác định&#xa;  sau khi technician kiểm tra xe" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1170" y="1500" width="200" height="100" as="geometry" />
        </mxCell>

        <!-- Message 39: confirmationEmail -->
        <mxCell id="msg39" value="confirmationEmail" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="1310" y="1630" as="sourcePoint" />
            <mxPoint x="100" y="1630" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 40: SELECT Appointment WITH populate -->
        <mxCell id="msg40" value="SELECT Appointment WITH populate(vehicle)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="445" y="1660" as="sourcePoint" />
            <mxPoint x="1150" y="1660" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="db-act7" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1145" y="1660" width="10" height="40" as="geometry" />
        </mxCell>

        <!-- Return: PopulatedAppointment -->
        <mxCell id="msg41" value="PopulatedAppointment" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="1150" y="1690" as="sourcePoint" />
            <mxPoint x="440" y="1690" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Return: success response to UI -->
        <mxCell id="msg42" value="{success: true, data: Appointment}" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="440" y="1710" as="sourcePoint" />
            <mxPoint x="270" y="1710" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 43: showAppointmentConfirmation -->
        <mxCell id="msg43" value="showAppointmentConfirmation()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="270" y="1740" as="sourcePoint" />
            <mxPoint x="100" y="1740" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Alt divider line -->
        <mxCell id="alt-divider" value="" style="endArrow=none;html=1;strokeWidth=2;strokeColor=#6c8ebf;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="60" y="1760" as="sourcePoint" />
            <mxPoint x="1380" y="1760" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- FAILED FLOW -->
        <!-- Condition Failed -->
        <mxCell id="alt-cond2" value="[vnp_ResponseCode != &quot;00&quot;] Payment Failed" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=2;" vertex="1" parent="1">
          <mxGeometry x="100" y="1765" width="300" height="20" as="geometry" />
        </mxCell>

        <!-- Message 44: GET /api/vnpay/return [failed] -->
        <mxCell id="msg44" value="GET /api/vnpay/return [vnp_ResponseCode != '00']" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="980" y="1800" as="sourcePoint" />
            <mxPoint x="620" y="1800" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="vnpay-act3" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="615" y="1800" width="10" height="200" as="geometry" />
        </mxCell>

        <!-- Self-call: verifyReturnUrl (failed) -->
        <mxCell id="msg45" value="verifyReturnUrl()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="0.1" y="10" relative="1" as="geometry">
            <mxPoint x="625" y="1820" as="sourcePoint" />
            <mxPoint x="680" y="1820" as="targetPoint" />
            <Array as="points">
              <mxPoint x="660" y="1820" />
              <mxPoint x="660" y="1840" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 46: SELECT Transaction (failed) -->
        <mxCell id="msg46" value="SELECT Transaction" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="625" y="1860" as="sourcePoint" />
            <mxPoint x="1150" y="1860" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="db-act8" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1145" y="1860" width="10" height="40" as="geometry" />
        </mxCell>

        <!-- Return: Transaction -->
        <mxCell id="msg47" value="Transaction" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="1150" y="1890" as="sourcePoint" />
            <mxPoint x="620" y="1890" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 48: updateTransactionStatus(failed) -->
        <mxCell id="msg48" value="updateTransactionStatus(failed, data)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="625" y="1920" as="sourcePoint" />
            <mxPoint x="800" y="1920" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="txsvc-act4" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="795" y="1920" width="10" height="100" as="geometry" />
        </mxCell>

        <!-- Message 49: UPDATE Transaction failed -->
        <mxCell id="msg49" value="UPDATE Transaction SET status = 'failed'" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="805" y="1940" as="sourcePoint" />
            <mxPoint x="1150" y="1940" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="db-act9" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1145" y="1940" width="10" height="50" as="geometry" />
        </mxCell>

        <!-- Failed Update Note -->
        <mxCell id="failed-note" value="Update:&#xa;- status: 'failed'&#xa;- errorCode: vnp_ResponseCode&#xa;- errorMessage: 'Payment failed'" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="870" y="1920" width="200" height="70" as="geometry" />
        </mxCell>

        <!-- Return: OK -->
        <mxCell id="msg50" value="OK" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="1150" y="1980" as="sourcePoint" />
            <mxPoint x="800" y="1980" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Return: Transaction to VNPay -->
        <mxCell id="msg51" value="Transaction" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="800" y="2010" as="sourcePoint" />
            <mxPoint x="620" y="2010" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 52: redirect to client failed -->
        <mxCell id="msg52" value="redirect(clientUrl/payment/vnpay-return?success=false&amp;error=...)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="620" y="2040" as="sourcePoint" />
            <mxPoint x="980" y="2040" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 53: redirect to UI -->
        <mxCell id="msg53" value="redirect" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="980" y="2070" as="sourcePoint" />
            <mxPoint x="270" y="2070" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="ui-act4" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="265" y="2070" width="10" height="60" as="geometry" />
        </mxCell>

        <!-- Message 54: displayPaymentFailed -->
        <mxCell id="msg54" value="displayPaymentFailed()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="270" y="2090" as="sourcePoint" />
            <mxPoint x="100" y="2090" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Note: Customer options after failure -->
        <mxCell id="customer-options-note" value="Customer có thể:&#xa;- Retry payment&#xa;- Cancel booking&#xa;- Contact support" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="80" y="2120" width="150" height="60" as="geometry" />
        </mxCell>

        <!-- Business Rules Note at bottom -->
        <mxCell id="business-rules" value="Business Rules:&#xa;1. Deposit amount cố định: 200,000 VND&#xa;2. Appointment auto-confirmed sau khi thanh toán thành công&#xa;3. Transaction lifecycle: pending → completed/failed&#xa;4. Deposit Booking: services[] = empty, xác định sau khi kiểm tra xe&#xa;5. Customer chỉ chọn ngày/giờ và xe, không chọn dịch vụ&#xa;&#xa;Technical Details:&#xa;- VNPay amount: VND * 100 (20,000,000 = 200k VND)&#xa;- Transaction ref format: APP{timestamp}{random9chars}&#xa;- Appointment number format: APT{YYMMDD}{random3digits}&#xa;- Payment timeout: 15 minutes&#xa;- bookingType: &quot;deposit_booking&quot; (services empty)" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;size=10;" vertex="1" parent="1">
          <mxGeometry x="80" y="1800" width="1280" height="140" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
