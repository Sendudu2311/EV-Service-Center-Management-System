<mxfile host="Electron" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/28.0.4 Chrome/138.0.7204.97 Electron/37.2.1 Safari/537.36" version="28.0.4">
  <diagram name="Cancellation and Refund Flow" id="cancel-refund-diagram">
    <mxGraphModel dx="2046" dy="1290" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="2400" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="title" value="Appointment Cancellation and Refund Flow&#xa;EV Service Center Management System" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="400" y="20" width="800" height="40" as="geometry" />
        </mxCell>
        <mxCell id="customer-box" value="Customer" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;outlineConnect=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="80" y="100" width="40" height="80" as="geometry" />
        </mxCell>
        <mxCell id="customer-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="100" y="2130" as="sourcePoint" />
            <mxPoint x="100" y="180" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ui-box" value="BookingPage" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="220" y="120" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="ui-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="270" y="2180" as="sourcePoint" />
            <mxPoint x="270" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="appsvc-box" value="AppointmentService" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="380" y="120" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="appsvc-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="440" y="2070" as="sourcePoint" />
            <mxPoint x="440" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="txsvc-box" value="TransactionService" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="560" y="120" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="txsvc-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;exitX=0.512;exitY=0.939;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" edge="1" source="alt-frame">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="620" y="2350" as="sourcePoint" />
            <mxPoint x="620" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="db-box" value="Database" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="740" y="120" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="db-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" parent="1" edge="1" source="db-act1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="790" y="2350" as="sourcePoint" />
            <mxPoint x="790" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="staff-box" value="Staff" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;outlineConnect=0;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="920" y="100" width="40" height="80" as="geometry" />
        </mxCell>
        <mxCell id="staff-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="940" y="2180" as="sourcePoint" />
            <mxPoint x="940" y="180" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="email-box" value="EmailService" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="1060" y="120" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="email-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;exitX=0.958;exitY=0.934;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" edge="1" source="par-frame">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1110" y="2350" as="sourcePoint" />
            <mxPoint x="1110" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="slot-box" value="SlotService" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="1220" y="120" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="slot-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;exitX=0.966;exitY=0.875;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" edge="1" source="opt-frame">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1270" y="1270" as="sourcePoint" />
            <mxPoint x="1270" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="usecase-note" value="Use Case: Customer yêu cầu hủy appointment và nhận hoàn tiền&lt;br&gt;Pre-condition: Appointment đã được tạo với trạng thái hợp lệ (confirmed/scheduled)&lt;br&gt;Post-condition: Appointment bị hủy, cọc/tiền được hoàn lại cho customer&lt;br&gt;Business Rule: Hoàn 100% nếu hủy &amp;gt;24h trước lịch hẹn, 50% nếu &amp;lt;24h" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;size=10;" parent="1" vertex="1">
          <mxGeometry x="80" y="220" width="1240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="phase1-label" value="PHASE 1: CUSTOMER YÊU CẦU HỦY APPOINTMENT" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#0066CC;" parent="1" vertex="1">
          <mxGeometry x="80" y="300" width="1240" height="20" as="geometry" />
        </mxCell>
        <mxCell id="msg1" value="viewAppointment()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-0.4118" y="20" relative="1" as="geometry">
            <mxPoint x="100" y="340" as="sourcePoint" />
            <mxPoint x="270" y="340" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ui-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="265" y="340" width="10" height="80" as="geometry" />
        </mxCell>
        <mxCell id="msg2" value="clickCancelButton()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-0.4118" y="20" relative="1" as="geometry">
            <mxPoint x="100" y="380" as="sourcePoint" />
            <mxPoint x="270" y="380" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg3" value="showCancellationForm()" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" parent="1" edge="1">
          <mxGeometry x="0.4118" y="-20" relative="1" as="geometry">
            <mxPoint x="270" y="410" as="sourcePoint" />
            <mxPoint x="100" y="410" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg4" value="submitCancellationRequest(reason, refundMethod)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-1" y="30" relative="1" as="geometry">
            <mxPoint x="100" y="450" as="sourcePoint" />
            <mxPoint x="270" y="450" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ui-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="265" y="450" width="10" height="360" as="geometry" />
        </mxCell>
        <mxCell id="cancel-form-note" value="Cancellation form:&#xa;- Reason (required)&#xa;- Refund method: cash | bank_transfer&#xa;- Bank info (if bank_transfer):&#xa;  • bankName, accountNumber&#xa;  • accountHolder&#xa;  • bankProofImage" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="90" y="470" width="150" height="110" as="geometry" />
        </mxCell>
        <mxCell id="msg5" value="POST /api/appointments/:id/request-cancel" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-0.9394" y="30" relative="1" as="geometry">
            <mxPoint x="275" y="490" as="sourcePoint" />
            <mxPoint x="440" y="490" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="appsvc-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="435" y="490" width="10" height="280" as="geometry" />
        </mxCell>
        <mxCell id="msg6" value="SELECT Appointment WHERE _id" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;exitX=0.876;exitY=0.035;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" edge="1" target="db-act1" source="appsvc-act1">
          <mxGeometry x="-0.3187" y="20" relative="1" as="geometry">
            <mxPoint x="450" y="499" as="sourcePoint" />
            <mxPoint x="790" y="520" as="targetPoint" />
            <mxPoint as="offset" />
            <Array as="points">
              <mxPoint x="710" y="500" />
              <mxPoint x="710" y="500" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="msg7" value="Appointment" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;exitX=0;exitY=0.75;exitDx=0;exitDy=0;" parent="1" edge="1" source="db-act1">
          <mxGeometry x="0.0741" y="-20" relative="1" as="geometry">
            <mxPoint x="780" y="550" as="sourcePoint" />
            <mxPoint x="440" y="530" as="targetPoint" />
            <mxPoint as="offset" />
            <Array as="points">
              <mxPoint x="443" y="530" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="msg8" value="canBeCancelledByCustomer()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;entryX=0.981;entryY=0.393;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" edge="1" target="appsvc-act1">
          <mxGeometry x="-0.4751" relative="1" as="geometry">
            <mxPoint x="445" y="580" as="sourcePoint" />
            <mxPoint x="450" y="600" as="targetPoint" />
            <Array as="points">
              <mxPoint x="480" y="580" />
              <mxPoint x="480" y="600" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="validate-note" value="Validation:&lt;br&gt;- Customer owns appointment&lt;br&gt;- Status: confirmed|scheduled&lt;br&gt;- Calculate refund %:&lt;br&gt;  • 100% if &amp;gt;24h before&lt;br&gt;  • 50% if &amp;lt;24h before&lt;br&gt;  • 0% if already started" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="625" y="550" width="142.5" height="80" as="geometry" />
        </mxCell>
        <mxCell id="msg9" value="requestCancellation(reason, refundInfo)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;entryX=0.9;entryY=0.569;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" edge="1" target="appsvc-act1">
          <mxGeometry x="-0.4751" relative="1" as="geometry">
            <mxPoint x="445" y="630" as="sourcePoint" />
            <mxPoint x="500" y="630" as="targetPoint" />
            <Array as="points">
              <mxPoint x="480" y="630" />
              <mxPoint x="480" y="649" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg10" value="UPDATE Appointment SET status=&#39;cancel_requested&#39;" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1" target="db-act2">
          <mxGeometry x="-0.6232" y="20" relative="1" as="geometry">
            <mxPoint x="445" y="680" as="sourcePoint" />
            <mxPoint x="790" y="680" as="targetPoint" />
            <mxPoint as="offset" />
            <Array as="points">
              <mxPoint x="700" y="680" />
              <mxPoint x="700" y="680" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="db-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="785" y="680" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="cancel-req-note" value="cancelRequest:&#xa;- requestedBy: customerId&#xa;- requestedAt: now()&#xa;- reason: string&#xa;- refundPercentage: 100|50&#xa;- refundMethod: cash|bank_transfer&#xa;- customerBankInfo (if bank_transfer)" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="640" y="740" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="msg11" value="OK" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;exitX=0;exitY=0.75;exitDx=0;exitDy=0;entryX=0.952;entryY=0.785;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" edge="1" target="appsvc-act1" source="db-act2">
          <mxGeometry x="0.2033" y="-20" relative="1" as="geometry">
            <mxPoint x="780" y="710" as="sourcePoint" />
            <mxPoint x="450" y="710" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg12" value="{success, refundPercentage, message}" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;entryX=1.015;entryY=0.861;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" edge="1" target="ui-act2">
          <mxGeometry x="0.9415" y="-20" relative="1" as="geometry">
            <mxPoint x="440" y="760" as="sourcePoint" />
            <mxPoint x="280" y="760" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg13" value="showCancelRequestSuccess()" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;exitX=0.051;exitY=0.974;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" edge="1" source="ui-act2">
          <mxGeometry x="0.8824" y="-20" relative="1" as="geometry">
            <mxPoint x="260" y="800" as="sourcePoint" />
            <mxPoint x="100" y="800" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="phase2-label" value="PHASE 2: STAFF DUYỆT YÊU CẦU HỦY" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#0066CC;" parent="1" vertex="1">
          <mxGeometry x="76.25" y="850" width="1240" height="20" as="geometry" />
        </mxCell>
        <mxCell id="msg14" value="viewCancelRequests()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-0.1045" y="-10" relative="1" as="geometry">
            <mxPoint x="940" y="880" as="sourcePoint" />
            <mxPoint x="270" y="880" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ui-act3" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="265" y="880" width="10" height="400" as="geometry" />
        </mxCell>
        <mxCell id="msg15" value="GET /api/appointments?status=cancel_requested" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-1" y="30" relative="1" as="geometry">
            <mxPoint x="275" y="910" as="sourcePoint" />
            <mxPoint x="440" y="910" as="targetPoint" />
            <mxPoint x="-5" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="appsvc-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="435" y="910" width="10" height="60" as="geometry" />
        </mxCell>
        <mxCell id="msg16" value="[Appointments with cancel_requested]" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;exitX=0.038;exitY=0.838;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" edge="1" source="appsvc-act2">
          <mxGeometry x="1" y="-30" relative="1" as="geometry">
            <mxPoint x="430" y="960" as="sourcePoint" />
            <mxPoint x="270" y="960" as="targetPoint" />
            <mxPoint x="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg17" value="displayCancelRequests()" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;exitX=1.094;exitY=0.275;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" edge="1" source="ui-act3">
          <mxGeometry x="-0.0455" relative="1" as="geometry">
            <mxPoint x="270" y="990" as="sourcePoint" />
            <mxPoint x="940" y="990" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg18" value="approveCancellation(notes)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;entryX=0.996;entryY=0.375;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" edge="1" target="ui-act3">
          <mxGeometry x="-0.1286" y="-20" relative="1" as="geometry">
            <mxPoint x="940" y="1030" as="sourcePoint" />
            <mxPoint x="280" y="1030" as="targetPoint" />
            <mxPoint x="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg19" value="POST /api/appointments/:id/approve-cancel" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-1" y="30" relative="1" as="geometry">
            <mxPoint x="275" y="1060" as="sourcePoint" />
            <mxPoint x="440" y="1060" as="targetPoint" />
            <mxPoint x="-5" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="appsvc-act3" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="435" y="1060" width="10" height="220" as="geometry" />
        </mxCell>
        <mxCell id="msg20" value="approveCancellation(staffId, notes)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="0.1" y="10" relative="1" as="geometry">
            <mxPoint x="445" y="1090" as="sourcePoint" />
            <mxPoint x="445" y="1110" as="targetPoint" />
            <Array as="points">
              <mxPoint x="480" y="1090" />
              <mxPoint x="480" y="1110" />
              <mxPoint x="445" y="1110" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg21" value="UPDATE Appointment SET status=&#39;cancel_approved&#39;" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1" target="db-act3">
          <mxGeometry x="-0.8551" y="50" relative="1" as="geometry">
            <mxPoint x="445" y="1130" as="sourcePoint" />
            <mxPoint x="790" y="1130" as="targetPoint" />
            <mxPoint as="offset" />
            <Array as="points">
              <mxPoint x="445" y="1131" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="db-act3" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="785" y="1130" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="cancel-approval-note" value="cancelRequest update:&#xa;- approvedBy: staffId&#xa;- approvedAt: now()&#xa;- staffNotes: notes" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="820" y="1120" width="160" height="70" as="geometry" />
        </mxCell>
        <mxCell id="msg22" value="OK" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;exitX=0;exitY=0.75;exitDx=0;exitDy=0;" parent="1" edge="1" source="db-act3">
          <mxGeometry x="0.2447" y="-20" relative="1" as="geometry">
            <mxPoint x="780" y="1160" as="sourcePoint" />
            <mxPoint x="440" y="1160" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="opt-frame" value="opt [Appointment has slotId]" style="shape=rect;html=1;whiteSpace=wrap;align=left;verticalAlign=top;fillColor=none;strokeColor=#666666;strokeWidth=1;dashed=1;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="420" y="1180" width="880" height="80" as="geometry" />
        </mxCell>
        <mxCell id="msg23" value="releaseSlot(slotId)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;entryX=0;entryY=0;entryDx=0;entryDy=0;" parent="1" edge="1" target="slot-act1">
          <mxGeometry x="-0.6691" y="21" relative="1" as="geometry">
            <mxPoint x="445" y="1210" as="sourcePoint" />
            <mxPoint x="1260" y="1210" as="targetPoint" />
            <mxPoint as="offset" />
            <Array as="points">
              <mxPoint x="856" y="1210" />
              <mxPoint x="1265" y="1210" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="slot-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="1265" y="1210" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="slot-release-note" value="Release slot:&#xa;- status: &#39;available&#39;&#xa;- appointmentId: null&#xa;- Clear booking info" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1320" y="1200" width="140" height="70" as="geometry" />
        </mxCell>
        <mxCell id="msg24" value="OK" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;exitX=0;exitY=0.75;exitDx=0;exitDy=0;" parent="1" edge="1" source="slot-act1">
          <mxGeometry x="-0.1549" y="-20" relative="1" as="geometry">
            <mxPoint x="1260" y="1240" as="sourcePoint" />
            <mxPoint x="440" y="1240" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg25" value="{success, status: &#39;cancel_approved&#39;}" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;exitX=0.988;exitY=0.946;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" edge="1" source="appsvc-act3">
          <mxGeometry x="-0.28" y="20" relative="1" as="geometry">
            <mxPoint x="450" y="1270" as="sourcePoint" />
            <mxPoint x="940" y="1270" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="phase3-label" value="PHASE 3: STAFF XỬ LÝ HOÀN TIỀN" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#0066CC;" parent="1" vertex="1">
          <mxGeometry x="80" y="1310" width="1240" height="20" as="geometry" />
        </mxCell>
        <mxCell id="msg26" value="processRefund()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-0.1045" y="-30" relative="1" as="geometry">
            <mxPoint x="940" y="1350" as="sourcePoint" />
            <mxPoint x="270" y="1350" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ui-act4" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="265" y="1350" width="10" height="720" as="geometry" />
        </mxCell>
        <mxCell id="msg27" value="showRefundForm()" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" parent="1" edge="1">
          <mxGeometry x="-0.0746" y="20" relative="1" as="geometry">
            <mxPoint x="275" y="1380" as="sourcePoint" />
            <mxPoint x="940" y="1380" as="targetPoint" />
            <mxPoint x="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="refund-form-note" value="Refund form:&#xa;- Refund proof image (required)&#xa;- Staff notes (optional)" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="950" y="1350" width="180" height="60" as="geometry" />
        </mxCell>
        <mxCell id="msg28" value="submitRefund(refundProofImage, notes)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="0.0746" y="-30" relative="1" as="geometry">
            <mxPoint x="940" y="1430" as="sourcePoint" />
            <mxPoint x="270" y="1430" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg29" value="POST /api/appointments/:id/process-refund" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-0.8182" y="30" relative="1" as="geometry">
            <mxPoint x="275" y="1460" as="sourcePoint" />
            <mxPoint x="440" y="1460" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="appsvc-act4" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="435" y="1460" width="10" height="570" as="geometry" />
        </mxCell>
        <mxCell id="msg30" value="SELECT Appointment WHERE _id" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1" target="db-act4">
          <mxGeometry x="-0.8286" y="30" relative="1" as="geometry">
            <mxPoint x="445" y="1490" as="sourcePoint" />
            <mxPoint x="790" y="1490" as="targetPoint" />
            <mxPoint as="offset" />
            <Array as="points">
              <mxPoint x="700" y="1490" />
              <mxPoint x="700" y="1490" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="db-act4" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="785" y="1490" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="msg31" value="Appointment" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" parent="1" edge="1">
          <mxGeometry x="0.2" y="-20" relative="1" as="geometry">
            <mxPoint x="790" y="1520" as="sourcePoint" />
            <mxPoint x="440" y="1520" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg32" value="calculateRefundAmount()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;entryX=0.952;entryY=0.194;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" edge="1" target="appsvc-act4">
          <mxGeometry x="-0.4751" relative="1" as="geometry">
            <mxPoint x="445" y="1550" as="sourcePoint" />
            <mxPoint x="450" y="1570" as="targetPoint" />
            <Array as="points">
              <mxPoint x="480" y="1550" />
              <mxPoint x="480" y="1571" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="refund-calc-note" value="Refund calculation:&lt;br&gt;- If deposit_booking:&lt;br&gt;  baseAmount = depositInfo.amount (200k)&lt;br&gt;&lt;br&gt;refundAmount = baseAmount * refundPercentage / 100" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="595" y="1530" width="190" height="80" as="geometry" />
        </mxCell>
        <mxCell id="alt-frame" value="alt" style="shape=rect;html=1;whiteSpace=wrap;align=left;verticalAlign=top;fillColor=none;strokeColor=#666666;strokeWidth=1;dashed=1;fontSize=12;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="410" y="1610" width="410" height="330" as="geometry" />
        </mxCell>
        <mxCell id="alt-cond1" value="[Refund method: cash]" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;fontStyle=2;" parent="1" vertex="1">
          <mxGeometry x="430" y="1610" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="msg33" value="createTransaction(cash, transactionData)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-1" y="21" relative="1" as="geometry">
            <mxPoint x="445" y="1640" as="sourcePoint" />
            <mxPoint x="620" y="1640" as="targetPoint" />
            <mxPoint x="-5" y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="txsvc-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="615" y="1640" width="10" height="100" as="geometry" />
        </mxCell>
        <mxCell id="cash-tx-note" value="Cash transaction:&#xa;- paymentPurpose: &#39;refund&#39;&#xa;- amount: refundAmount&#xa;- cashData: {&#xa;    receivedBy: staffId,&#xa;    receiptNumber: REFUND_CASH_xxx,&#xa;    receiptImage: refundProofImage&#xa;  }" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=9;" parent="1" vertex="1">
          <mxGeometry x="800" y="1650" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="msg34" value="INSERT Transaction" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1" target="db-act5">
          <mxGeometry x="-0.7" y="20" relative="1" as="geometry">
            <mxPoint x="625" y="1670" as="sourcePoint" />
            <mxPoint x="790" y="1670" as="targetPoint" />
            <mxPoint as="offset" />
            <Array as="points">
              <mxPoint x="740" y="1670" />
              <mxPoint x="740" y="1670" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="db-act5" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="785" y="1670" width="10" height="30" as="geometry" />
        </mxCell>
        <mxCell id="msg35" value="transactionId" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" parent="1" edge="1">
          <mxGeometry x="0.4118" y="-15" relative="1" as="geometry">
            <mxPoint x="790" y="1695" as="sourcePoint" />
            <mxPoint x="620" y="1695" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg36" value="updateStatus(completed)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-0.3" relative="1" as="geometry">
            <mxPoint x="625" y="1710" as="sourcePoint" />
            <mxPoint x="625" y="1730" as="targetPoint" />
            <Array as="points">
              <mxPoint x="660" y="1710" />
              <mxPoint x="660" y="1730" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg37" value="Transaction" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;exitX=0;exitY=0.9;exitDx=0;exitDy=0;" parent="1" edge="1" source="txsvc-act1">
          <mxGeometry x="0.3" y="-12" relative="1" as="geometry">
            <mxPoint x="620" y="1750" as="sourcePoint" />
            <mxPoint x="440" y="1730" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="alt-divider" value="" style="endArrow=none;html=1;strokeWidth=1;strokeColor=#666666;dashed=1;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="420" y="1780" as="sourcePoint" />
            <mxPoint x="820" y="1780" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="alt-cond2" value="[Refund method: bank_transfer]" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;fontStyle=2;" parent="1" vertex="1">
          <mxGeometry x="430" y="1780" width="180" height="20" as="geometry" />
        </mxCell>
        <mxCell id="msg38" value="createTransaction(bank_transfer, transactionData)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-0.4" y="20" relative="1" as="geometry">
            <mxPoint x="445" y="1810" as="sourcePoint" />
            <mxPoint x="620" y="1810" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="txsvc-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="615" y="1810" width="10" height="100" as="geometry" />
        </mxCell>
        <mxCell id="bank-tx-note" value="Bank transfer transaction:&#xa;- paymentPurpose: &#39;refund&#39;&#xa;- amount: refundAmount&#xa;- bankTransferData: {&#xa;    bankName, accountNumber,&#xa;    accountHolder,&#xa;    transferRef: REFUND_TRF_xxx,&#xa;    receiptImage: refundProofImage&#xa;  }" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=9;" parent="1" vertex="1">
          <mxGeometry x="800" y="1790" width="200" height="110" as="geometry" />
        </mxCell>
        <mxCell id="msg39" value="INSERT Transaction" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1" target="db-act6">
          <mxGeometry x="-0.7" y="20" relative="1" as="geometry">
            <mxPoint x="625" y="1840" as="sourcePoint" />
            <mxPoint x="790" y="1840" as="targetPoint" />
            <mxPoint as="offset" />
            <Array as="points">
              <mxPoint x="625" y="1841" />
              <mxPoint x="706" y="1841" />
              <mxPoint x="706" y="1840" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="db-act6" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="785" y="1840" width="10" height="30" as="geometry" />
        </mxCell>
        <mxCell id="msg40" value="transactionId" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" parent="1" edge="1">
          <mxGeometry x="0.15" y="-12" relative="1" as="geometry">
            <mxPoint x="790" y="1865" as="sourcePoint" />
            <mxPoint x="620" y="1865" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg41" value="updateStatus(completed)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-0.3" relative="1" as="geometry">
            <mxPoint x="625" y="1880" as="sourcePoint" />
            <mxPoint x="625" y="1900" as="targetPoint" />
            <Array as="points">
              <mxPoint x="660" y="1880" />
              <mxPoint x="660" y="1900" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg42" value="Transaction" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;exitX=0;exitY=0.9;exitDx=0;exitDy=0;" parent="1" edge="1" source="txsvc-act2">
          <mxGeometry x="0.3" y="-12" relative="1" as="geometry">
            <mxPoint x="620" y="1920" as="sourcePoint" />
            <mxPoint x="440" y="1900" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg43" value="processRefund(staffId, transactionId)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;entryX=0.924;entryY=0.894;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" edge="1" target="appsvc-act4">
          <mxGeometry x="-0.4751" relative="1" as="geometry">
            <mxPoint x="445" y="1950" as="sourcePoint" />
            <mxPoint x="500" y="1950" as="targetPoint" />
            <Array as="points">
              <mxPoint x="480" y="1950" />
              <mxPoint x="480" y="1970" />
              <mxPoint x="449" y="1970" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg44" value="UPDATE Appointment SET status=&#39;refunded&#39;" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1" target="db-act7">
          <mxGeometry x="-0.6232" y="20" relative="1" as="geometry">
            <mxPoint x="445" y="1990" as="sourcePoint" />
            <mxPoint x="790" y="1990" as="targetPoint" />
            <mxPoint as="offset" />
            <Array as="points">
              <mxPoint x="445" y="1991" />
              <mxPoint x="616" y="1991" />
              <mxPoint x="616" y="1990" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="db-act7" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="785" y="1990" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="refund-info-note" value="Refund info:&#xa;- refundedBy: staffId&#xa;- refundedAt: now()&#xa;- refundTransactionId: transactionId&#xa;- refundProofImage: image&#xa;- refundNotes: notes" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="880" y="1965" width="180" height="90" as="geometry" />
        </mxCell>
        <mxCell id="msg45" value="OK" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;exitX=0;exitY=0.75;exitDx=0;exitDy=0;" parent="1" edge="1" source="db-act7">
          <mxGeometry x="0.2089" y="-20" relative="1" as="geometry">
            <mxPoint x="790" y="2020" as="sourcePoint" />
            <mxPoint x="440" y="2020" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg46" value="SELECT User WHERE customerId" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1" target="db-act8">
          <mxGeometry x="-0.6232" y="20" relative="1" as="geometry">
            <mxPoint x="445" y="2040" as="sourcePoint" />
            <mxPoint x="790" y="2040" as="targetPoint" />
            <mxPoint as="offset" />
            <Array as="points">
              <mxPoint x="700" y="2040" />
              <mxPoint x="700" y="2040" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="db-act8" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="785" y="2040" width="10" height="30" as="geometry" />
        </mxCell>
        <mxCell id="msg47" value="Customer(email)" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;exitX=0;exitY=0.67;exitDx=0;exitDy=0;" parent="1" edge="1" source="db-act8">
          <mxGeometry x="0.2089" y="-20" relative="1" as="geometry">
            <mxPoint x="790" y="2060" as="sourcePoint" />
            <mxPoint x="440" y="2060" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="par-frame" value="par [Send refund notification email]" style="shape=rect;html=1;whiteSpace=wrap;align=left;verticalAlign=top;fillColor=none;strokeColor=#666666;strokeWidth=1;dashed=1;fontSize=12;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="420" y="2080" width="720" height="60" as="geometry" />
        </mxCell>
        <mxCell id="msg48" value="sendRefundNotification(refundData)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-0.1128" y="20" relative="1" as="geometry">
            <mxPoint x="445" y="2100" as="sourcePoint" />
            <mxPoint x="1110" y="2100" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="email-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="1105" y="2100" width="10" height="30" as="geometry" />
        </mxCell>
        <mxCell id="email-note" value="Email content:&#xa;- Appointment number&#xa;- Refund amount: XXX,XXX VND&#xa;- Refund percentage: 100%|50%&#xa;- Refund method: cash|bank_transfer&#xa;- Transaction reference" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1150" y="2080" width="200" height="90" as="geometry" />
        </mxCell>
        <mxCell id="msg49" value="refundNotificationEmail" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry x="-0.8" y="20" relative="1" as="geometry">
            <mxPoint x="1110" y="2120" as="sourcePoint" />
            <mxPoint x="100" y="2120" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg50" value="{success, refundAmount, transactionRef}" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="1" y="10" relative="1" as="geometry">
            <mxPoint x="440" y="2150" as="sourcePoint" />
            <mxPoint x="270" y="2150" as="targetPoint" />
            <mxPoint x="-10" y="-10" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg51" value="showRefundSuccess()" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.0746" y="20" relative="1" as="geometry">
            <mxPoint x="270" y="2180" as="sourcePoint" />
            <mxPoint x="940" y="2180" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="refund-complete-note" value="Business Rules:&#xa;1. Refund amount = baseAmount * refundPercentage&#xa;2. baseAmount: depositInfo.amount (deposit_booking) OR totalAmount (full_service)&#xa;3. Refund methods: cash (at counter) | bank_transfer (with proof)&#xa;4. Transaction created with status &#39;completed&#39;&#xa;5. Email notification sent to customer&#xa;&#xa;Status Flow: cancel_requested → cancel_approved → refunded" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;size=10;" parent="1" vertex="1">
          <mxGeometry x="100" y="2250" width="1240" height="120" as="geometry" />
        </mxCell>
        <mxCell id="-Rw0sW5XIMftSlOXBwE--3" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1" target="db-act1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="790" y="2070" as="sourcePoint" />
            <mxPoint x="790" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="db-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="785" y="500" width="10" height="40" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
