@startuml Cancellation and Refund Flow
!theme plain

' Cấu hình style
skinparam ParticipantPadding 20
skinparam BoxPadding 10
skinparam sequenceArrowThickness 2
skinparam roundcorner 5

' Màu sắc theo vai trò
skinparam participant {
    BackgroundColor<<Actor>> LightBlue
    BackgroundColor<<UI>> LightGreen
    BackgroundColor<<Service>> LightYellow
    BackgroundColor<<System>> WhiteSmoke
}

title Appointment Cancellation and Refund Flow\nEV Service Center Management System

' ============================================================================
' LIFELINES
' ============================================================================

actor Customer <<Actor>>
participant "BookingPage" as UI <<UI>>
participant "AppointmentService" as AppSvc <<Service>>
participant "TransactionService" as TxSvc <<Service>>
participant "Database" as DB <<System>>
actor Staff <<Actor>>
participant "EmailService" as Email <<System>>
participant "SlotService" as Slot <<System>>

note over Customer, Slot
    **Use Case:** Customer yêu cầu hủy appointment và nhận hoàn tiền
    **Pre-condition:** Appointment đã được tạo với trạng thái hợp lệ (confirmed/scheduled)
    **Post-condition:** Appointment bị hủy, cọc/tiền được hoàn lại cho customer
    **Business Rule:** Hoàn 100% nếu hủy >24h trước lịch hẹn, 50% nếu <24h
end note

== PHASE 1: Customer yêu cầu hủy appointment ==

Customer -> UI : viewAppointment()
activate UI

Customer -> UI : clickCancelButton()

UI --> Customer : showCancellationForm()
deactivate UI

note left of Customer
    Cancellation form:
    - Reason (required)
    - Refund method: cash | bank_transfer
    - Bank info (if bank_transfer):
      • bankName, accountNumber
      • accountHolder
      • bankProofImage
end note

Customer -> UI : submitCancellationRequest(reason, refundMethod)
activate UI

UI -> AppSvc : POST /api/appointments/:id/request-cancel
activate AppSvc

AppSvc -> DB : SELECT Appointment WHERE _id
activate DB
DB --> AppSvc : Appointment
deactivate DB

AppSvc -> AppSvc : canBeCancelledByCustomer()

note right of AppSvc
    Validation:
    - Customer owns appointment
    - Status: confirmed|scheduled
    - Calculate refund %:
      • 100% if >24h before
      • 50% if <24h before
      • 0% if already started
end note

AppSvc -> AppSvc : requestCancellation(reason, refundInfo)

AppSvc -> DB : UPDATE Appointment\nSET status = "cancel_requested"
activate DB

note right of DB
    cancelRequest:
    - requestedBy: customerId
    - requestedAt: now()
    - reason: string
    - refundPercentage: 100|50
    - refundMethod: cash|bank_transfer
    - customerBankInfo (if bank_transfer)
end note

DB --> AppSvc : OK
deactivate DB

AppSvc --> UI : {success, refundPercentage, message}
deactivate AppSvc

UI --> Customer : showCancelRequestSuccess()
deactivate UI

== PHASE 2: Staff duyệt yêu cầu hủy ==

Staff -> UI : viewCancelRequests()
activate UI

UI -> AppSvc : GET /api/appointments?status=cancel_requested
activate AppSvc

AppSvc -> DB : SELECT Appointments\nWHERE status = "cancel_requested"
activate DB
DB --> AppSvc : [Appointments]
deactivate DB

AppSvc --> UI : [Appointments with cancel_requested]
deactivate AppSvc

UI --> Staff : displayCancelRequests()

Staff -> UI : approveCancellation(notes)

UI -> AppSvc : POST /api/appointments/:id/approve-cancel
activate AppSvc

AppSvc -> AppSvc : approveCancellation(staffId, notes)

AppSvc -> DB : UPDATE Appointment\nSET status = "cancel_approved"
activate DB

note right of DB
    cancelRequest update:
    - approvedBy: staffId
    - approvedAt: now()
    - staffNotes: notes
end note

DB --> AppSvc : OK
deactivate DB

' Release slot if exists
opt Appointment has slotId
    AppSvc -> Slot : releaseSlot(slotId)
    activate Slot

    note right of Slot
        Release slot back to available:
        - status: "available"
        - appointmentId: null
        - Clear booking info
    end note

    Slot --> AppSvc : OK
    deactivate Slot
end

AppSvc --> UI : {success, status: "cancel_approved"}
deactivate AppSvc

UI --> Staff : showApprovalSuccess()
deactivate UI

== PHASE 3: Staff xử lý hoàn tiền ==

Staff -> UI : processRefund()
activate UI

UI --> Staff : showRefundForm()

note left of Staff
    Refund form:
    - Refund proof image (required)
    - Staff notes (optional)
end note

Staff -> UI : submitRefund(refundProofImage, notes)

UI -> AppSvc : POST /api/appointments/:id/process-refund
activate AppSvc

AppSvc -> DB : SELECT Appointment WHERE _id
activate DB
DB --> AppSvc : Appointment
deactivate DB

AppSvc -> AppSvc : calculateRefundAmount()

note right of AppSvc
    Refund calculation:
    - If deposit_booking:
      baseAmount = depositInfo.amount (200k)
    - If full_service:
      baseAmount = totalAmount

    refundAmount = baseAmount * refundPercentage / 100
end note

alt Refund method: cash
    AppSvc -> TxSvc : createTransaction(cash, transactionData)
    activate TxSvc

    note right of TxSvc
        Cash transaction:
        - paymentPurpose: "refund"
        - amount: refundAmount
        - cashData: {
            receivedBy: staffId,
            receiptNumber: REFUND_CASH_xxx,
            receiptImage: refundProofImage
          }
    end note

    TxSvc -> DB : INSERT Transaction
    activate DB
    DB --> TxSvc : transactionId
    deactivate DB

    TxSvc -> TxSvc : updateStatus(completed)

    TxSvc --> AppSvc : Transaction
    deactivate TxSvc

else Refund method: bank_transfer
    AppSvc -> TxSvc : createTransaction(bank_transfer, transactionData)
    activate TxSvc

    note right of TxSvc
        Bank transfer transaction:
        - paymentPurpose: "refund"
        - amount: refundAmount
        - bankTransferData: {
            bankName, accountNumber,
            accountHolder,
            transferRef: REFUND_TRF_xxx,
            receiptImage: refundProofImage
          }
    end note

    TxSvc -> DB : INSERT Transaction
    activate DB
    DB --> TxSvc : transactionId
    deactivate DB

    TxSvc -> TxSvc : updateStatus(completed)

    TxSvc --> AppSvc : Transaction
    deactivate TxSvc
end

AppSvc -> AppSvc : processRefund(staffId, transactionId)

AppSvc -> DB : UPDATE Appointment\nSET status = "refunded"
activate DB

note right of DB
    Refund info:
    - refundedBy: staffId
    - refundedAt: now()
    - refundTransactionId: transactionId
    - refundProofImage: image
    - refundNotes: notes
end note

DB --> AppSvc : OK
deactivate DB

' Get customer info for email notification
AppSvc -> DB : SELECT User WHERE customerId
activate DB
DB --> AppSvc : Customer(email)
deactivate DB

' Send email notification
par Send refund notification email
    AppSvc -> Email : sendRefundNotification(refundData)
    activate Email

    note right of Email
        Email content:
        - Appointment number
        - Refund amount: XXX,XXX VND
        - Refund percentage: 100%|50%
        - Refund method: cash|bank_transfer
        - Transaction reference
    end note

    Email -> Customer : refundNotificationEmail
    deactivate Email
end

AppSvc --> UI : {success, refundAmount, transactionRef}
deactivate AppSvc

UI --> Staff : showRefundSuccess()
deactivate UI

' ============================================================================
' NOTES - Business Rules
' ============================================================================

note over Customer, Slot
    **Business Rules:**
    1. Refund percentage calculation:
       - 100% if cancelled >24 hours before scheduledDate
       - 50% if cancelled <24 hours before scheduledDate
       - 0% if service already started (status: in_progress or later)

    2. Refund amount calculation:
       - deposit_booking: refund from depositInfo.amount (200,000 VND)
       - full_service: refund from totalAmount

    3. Refund methods:
       - cash: Customer nhận tiền mặt tại quầy (refundProofImage: staff chụp biên lai)
       - bank_transfer: Chuyển khoản vào tài khoản customer (refundProofImage: staff chụp proof transfer)

    4. Status flow:
       confirmed/scheduled → cancel_requested → cancel_approved → refunded

    5. Who can do what:
       - Customer: request cancellation (any time before service starts)
       - Staff: approve cancellation, process refund

    **Technical Details:**
    - Transaction ref format: REFUND_CASH_xxx or REFUND_TRF_xxx
    - Slot automatically released when cancellation approved
    - Email notification sent after refund completed

    **Edge Cases:**
    - If appointment has no slot (deposit_booking), skip slot release
    - If email fails, refund still processes (don't rollback)
    - If refundPercentage is 0%, transaction amount is 0 VND
end note

@enduml
