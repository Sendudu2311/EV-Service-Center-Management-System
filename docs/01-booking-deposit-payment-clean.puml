@startuml Booking with Deposit Payment Flow
!theme plain

skinparam ParticipantPadding 20
skinparam BoxPadding 10
skinparam sequenceArrowThickness 2
skinparam roundcorner 5

skinparam participant {
    BackgroundColor<<Actor>> LightBlue
    BackgroundColor<<UI>> LightGreen
    BackgroundColor<<Service>> LightYellow
    BackgroundColor<<External>> LightPink
    BackgroundColor<<System>> WhiteSmoke
}

title Booking with Deposit Payment Flow\nEV Service Center Management System

actor Customer <<Actor>>
participant "BookingPage" as UI <<UI>>
participant "AppointmentService" as AppSvc <<Service>>
participant "VNPayController" as VNPay <<Service>>
participant "TransactionService" as TxSvc <<Service>>
participant "VNPayGateway" as Gateway <<External>>
participant "Database" as DB <<System>>
participant "EmailService" as Email <<System>>

== PHASE 1: Customer điền form booking ==

Customer -> UI : fillBookingForm()
activate UI
UI -> UI : validateInput()
UI --> Customer : showBookingPreview()
deactivate UI

Customer -> UI : confirmBooking()
activate UI

== PHASE 2: Tạo Payment URL ==

UI -> VNPay : POST /api/vnpay/create-payment
activate VNPay

VNPay -> TxSvc : createTransaction(vnpay, data)
activate TxSvc

TxSvc -> DB : INSERT Transaction
activate DB
DB --> TxSvc : transactionId
deactivate DB

TxSvc --> VNPay : Transaction
deactivate TxSvc

VNPay -> VNPay : buildPaymentUrl()
VNPay --> UI : paymentUrl
deactivate VNPay

UI --> Customer : redirectToVNPay
deactivate UI

== PHASE 3: Thanh toán tại VNPay ==

Customer -> Gateway : enterPaymentInfo()
activate Gateway
Gateway -> Gateway : processPayment()

alt Payment Success
    Gateway -> VNPay : callback(success)
    activate VNPay

    VNPay -> VNPay : verifyReturnUrl()

    VNPay -> DB : SELECT Transaction
    activate DB
    DB --> VNPay : Transaction
    deactivate DB

    VNPay -> TxSvc : updateStatus(completed)
    activate TxSvc

    TxSvc -> DB : UPDATE Transaction
    activate DB
    DB --> TxSvc : OK
    deactivate DB

    TxSvc --> VNPay : Transaction
    deactivate TxSvc

    VNPay --> Gateway : redirect(success)
    deactivate VNPay

    Gateway --> Customer : paymentSuccess
    deactivate Gateway

    == PHASE 4: Tạo Appointment ==

    Customer -> UI : viewResult()
    activate UI

    UI -> AppSvc : POST /api/appointments
    activate AppSvc

    AppSvc -> DB : SELECT Vehicle
    activate DB
    DB --> AppSvc : Vehicle
    deactivate DB

    AppSvc -> AppSvc : generateAppointmentNumber()

    AppSvc -> DB : INSERT Appointment
    activate DB
    DB --> AppSvc : appointmentId
    deactivate DB

    AppSvc -> TxSvc : linkAppointment()
    activate TxSvc

    TxSvc -> DB : UPDATE Transaction
    activate DB
    DB --> TxSvc : OK
    deactivate DB

    TxSvc --> AppSvc : OK
    deactivate TxSvc

    == PHASE 5: Gửi Email ==

    AppSvc -> Email : sendConfirmation()
    activate Email
    Email --> Customer : confirmationEmail
    deactivate Email

    AppSvc -> DB : SELECT Appointment
    activate DB
    DB --> AppSvc : Appointment
    deactivate DB

    AppSvc --> UI : appointment
    deactivate AppSvc

    UI --> Customer : showConfirmation()
    deactivate UI

else Payment Failed
    Gateway -> VNPay : callback(failed)
    activate VNPay

    VNPay -> VNPay : verifyReturnUrl()

    VNPay -> DB : SELECT Transaction
    activate DB
    DB --> VNPay : Transaction
    deactivate DB

    VNPay -> TxSvc : updateStatus(failed)
    activate TxSvc

    TxSvc -> DB : UPDATE Transaction
    activate DB
    DB --> TxSvc : OK
    deactivate DB

    TxSvc --> VNPay : Transaction
    deactivate TxSvc

    VNPay --> Gateway : redirect(failed)
    deactivate VNPay

    Gateway --> Customer : paymentFailed
    deactivate Gateway

    Customer -> UI : viewError()
    activate UI
    UI --> Customer : showError()
    deactivate UI
end

@enduml
