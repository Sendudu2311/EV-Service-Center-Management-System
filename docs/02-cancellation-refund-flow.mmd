%% Appointment Cancellation and Refund Flow
%% EV Service Center Management System

sequenceDiagram
    %% Actors and Participants
    actor Customer
    participant UI as BookingPage
    participant AppSvc as AppointmentService
    participant TxSvc as TransactionService
    participant DB as Database
    actor Staff
    participant Email as EmailService
    participant Slot as SlotService

    %% ============================================================================
    %% Use Case Note
    %% ============================================================================

    Note over Customer,Slot: Use Case: Customer yêu cầu hủy appointment và nhận hoàn tiền<br/>Pre-condition: Appointment đã được tạo với trạng thái hợp lệ<br/>Business Rule: Hoàn 100% nếu hủy >24h trước, 50% nếu <24h

    %% ============================================================================
    %% PHASE 1: CUSTOMER YÊU CẦU HỦY
    %% ============================================================================

    Note over Customer,Slot: PHASE 1: Customer yêu cầu hủy appointment

    Customer->>+UI: viewAppointment()
    Customer->>UI: clickCancelButton()
    UI-->>-Customer: showCancellationForm()

    Note left of Customer: Cancellation form:<br/>- Reason (required)<br/>- Refund method: cash OR bank_transfer<br/>- Bank info (if bank_transfer)

    Customer->>+UI: submitCancellationRequest(reason, refundMethod)
    UI->>+AppSvc: POST /api/appointments/:id/request-cancel

    AppSvc->>+DB: SELECT Appointment WHERE _id
    DB-->>-AppSvc: Appointment

    AppSvc->>AppSvc: canBeCancelledByCustomer()

    Note right of AppSvc: Validation:<br/>- Customer owns appointment<br/>- Status: confirmed/scheduled<br/>- Calculate refund %:<br/>  100% if >24h before<br/>  50% if <24h before

    AppSvc->>AppSvc: requestCancellation(reason, refundInfo)

    AppSvc->>+DB: UPDATE Appointment<br/>SET status = "cancel_requested"

    Note right of DB: cancelRequest:<br/>- requestedBy: customerId<br/>- requestedAt: now()<br/>- refundPercentage: 100 OR 50<br/>- refundMethod: cash/bank_transfer

    DB-->>-AppSvc: OK

    AppSvc-->>-UI: {success, refundPercentage, message}
    UI-->>-Customer: showCancelRequestSuccess()

    %% ============================================================================
    %% PHASE 2: STAFF DUYỆT YÊU CẦU HỦY
    %% ============================================================================

    Note over Customer,Slot: PHASE 2: Staff duyệt yêu cầu hủy

    Staff->>+UI: viewCancelRequests()
    UI->>+AppSvc: GET /api/appointments?status=cancel_requested

    AppSvc->>+DB: SELECT Appointments<br/>WHERE status = "cancel_requested"
    DB-->>-AppSvc: [Appointments]

    AppSvc-->>-UI: [Appointments with cancel_requested]
    UI-->>Staff: displayCancelRequests()

    Staff->>UI: approveCancellation(notes)
    UI->>+AppSvc: POST /api/appointments/:id/approve-cancel

    AppSvc->>AppSvc: approveCancellation(staffId, notes)

    AppSvc->>+DB: UPDATE Appointment<br/>SET status = "cancel_approved"

    Note right of DB: cancelRequest update:<br/>- approvedBy: staffId<br/>- approvedAt: now()<br/>- staffNotes: notes

    DB-->>-AppSvc: OK

    opt Appointment has slotId
        AppSvc->>+Slot: releaseSlot(slotId)
        Note right of Slot: Release slot:<br/>- status: "available"<br/>- appointmentId: null
        Slot-->>-AppSvc: OK
    end

    AppSvc-->>-UI: {success, status: "cancel_approved"}
    UI-->>-Staff: showApprovalSuccess()

    %% ============================================================================
    %% PHASE 3: STAFF XỬ LÝ HOÀN TIỀN
    %% ============================================================================

    Note over Customer,Slot: PHASE 3: Staff xử lý hoàn tiền

    Staff->>+UI: processRefund()
    UI-->>Staff: showRefundForm()

    Note left of Staff: Refund form:<br/>- Refund proof image (required)<br/>- Staff notes (optional)

    Staff->>UI: submitRefund(refundProofImage, notes)
    UI->>+AppSvc: POST /api/appointments/:id/process-refund

    AppSvc->>+DB: SELECT Appointment WHERE _id
    DB-->>-AppSvc: Appointment

    AppSvc->>AppSvc: calculateRefundAmount()

    Note right of AppSvc: Refund calculation:<br/>- deposit_booking: baseAmount = 200k VND<br/>- full_service: baseAmount = totalAmount<br/>refundAmount = baseAmount × refundPercentage

    alt Refund method: cash
        AppSvc->>+TxSvc: createTransaction(cash, transactionData)

        Note right of TxSvc: Cash transaction:<br/>- paymentPurpose: "refund"<br/>- amount: refundAmount<br/>- cashData: {receiptNumber, receiptImage}

        TxSvc->>+DB: INSERT Transaction
        DB-->>-TxSvc: transactionId

        TxSvc->>TxSvc: updateStatus(completed)
        TxSvc-->>-AppSvc: Transaction

    else Refund method: bank_transfer
        AppSvc->>+TxSvc: createTransaction(bank_transfer, transactionData)

        Note right of TxSvc: Bank transfer transaction:<br/>- paymentPurpose: "refund"<br/>- amount: refundAmount<br/>- bankTransferData: {bankName, accountNumber, transferRef}

        TxSvc->>+DB: INSERT Transaction
        DB-->>-TxSvc: transactionId

        TxSvc->>TxSvc: updateStatus(completed)
        TxSvc-->>-AppSvc: Transaction
    end

    AppSvc->>AppSvc: processRefund(staffId, transactionId)

    AppSvc->>+DB: UPDATE Appointment<br/>SET status = "refunded"

    Note right of DB: Refund info:<br/>- refundedBy: staffId<br/>- refundedAt: now()<br/>- refundTransactionId<br/>- refundProofImage

    DB-->>-AppSvc: OK

    AppSvc->>+DB: SELECT User WHERE customerId
    DB-->>-AppSvc: Customer(email)

    par Send refund notification email
        AppSvc->>+Email: sendRefundNotification(refundData)

        Note right of Email: Email content:<br/>- Appointment number<br/>- Refund amount: XXX,XXX VND<br/>- Refund percentage: 100%/50%<br/>- Transaction reference

        Email->>Customer: refundNotificationEmail
        deactivate Email
    end

    AppSvc-->>-UI: {success, refundAmount, transactionRef}
    UI-->>-Staff: showRefundSuccess()

    %% ============================================================================
    %% Business Rules
    %% ============================================================================

    Note over Customer,Slot: Business Rules:<br/>1. Refund %: 100% if >24h, 50% if <24h, 0% if started<br/>2. Refund methods: cash (at counter) OR bank_transfer<br/>3. Status flow: confirmed → cancel_requested → cancel_approved → refunded<br/>4. Slot released when cancellation approved<br/>5. Email notification sent after refund completed
