%% Booking with Deposit Payment Flow
%% EV Service Center Management System

sequenceDiagram
    %% Actors and Participants
    actor Customer
    participant UI as BookingPage
    participant AppSvc as AppointmentService
    participant VNPay as VNPayController
    participant TxSvc as TransactionService
    participant Gateway as VNPayGateway
    participant DB as Database
    participant Email as EmailService

    %% ============================================================================
    %% PHASE 1: CUSTOMER ĐIỀN FORM BOOKING
    %% ============================================================================

    Note over Customer,Email: PHASE 1: Customer điền form booking

    Customer->>+UI: fillBookingForm()
    UI->>UI: validateInput()
    UI-->>-Customer: showBookingPreview()

    Customer->>+UI: confirmBooking()

    %% ============================================================================
    %% PHASE 2: TẠO PAYMENT URL
    %% ============================================================================

    Note over Customer,Email: PHASE 2: Tạo Payment URL

    UI->>+VNPay: POST /api/vnpay/create-payment

    VNPay->>+TxSvc: createTransaction(vnpay, data)
    TxSvc->>+DB: INSERT Transaction
    DB-->>-TxSvc: transactionId
    TxSvc-->>-VNPay: Transaction

    VNPay->>VNPay: buildPaymentUrl()
    VNPay-->>-UI: paymentUrl

    UI-->>-Customer: redirectToVNPay

    %% ============================================================================
    %% PHASE 3: THANH TOÁN TẠI VNPAY
    %% ============================================================================

    Note over Customer,Email: PHASE 3: Thanh toán tại VNPay

    Customer->>+Gateway: enterPaymentInfo()
    Gateway->>Gateway: processPayment()
    Gateway-->>-Customer: displayPaymentForm()

    %% ============================================================================
    %% ALT: Payment Success or Failed
    %% ============================================================================

    alt [vnp_ResponseCode == "00"] Payment Success
        Customer->>+Gateway: submitPayment()
        Gateway->>+VNPay: callback(success)

        Note right of VNPay: verifyReturnUrl()<br/>validate SecureHash
        VNPay->>VNPay: verifyReturnUrl()

        VNPay->>+DB: SELECT Transaction<br/>WHERE transactionRef = vnp_TxnRef
        DB-->>-VNPay: Transaction

        VNPay->>+TxSvc: updateStatus(completed)
        TxSvc->>+DB: UPDATE Transaction<br/>SET status = "completed"
        DB-->>-TxSvc: OK
        TxSvc-->>-VNPay: Transaction

        VNPay-->>-Gateway: redirect(success)
        Gateway-->>-Customer: paymentSuccess

        %% ========================================================================
        %% PHASE 4: TẠO APPOINTMENT
        %% ========================================================================

        Note over Customer,Email: PHASE 4: Tạo Appointment

        Customer->>+UI: viewResult()
        UI->>+AppSvc: POST /api/appointments

        AppSvc->>+DB: SELECT Vehicle<br/>WHERE _id = vehicleId
        DB-->>-AppSvc: Vehicle

        Note right of AppSvc: generateAppointmentNumber()<br/>Format: APT{YYMMDD}{random}
        AppSvc->>AppSvc: generateAppointmentNumber()

        AppSvc->>+DB: INSERT Appointment<br/>status: "confirmed"
        DB-->>-AppSvc: appointmentId

        AppSvc->>+TxSvc: linkAppointment()
        TxSvc->>+DB: UPDATE Transaction<br/>SET appointmentId
        DB-->>-TxSvc: OK
        TxSvc-->>-AppSvc: OK

        %% ========================================================================
        %% PHASE 5: GỬI EMAIL
        %% ========================================================================

        Note over Customer,Email: PHASE 5: Gửi Email

        AppSvc->>+Email: sendConfirmation()
        Note right of Email: Email content:<br/>- Appointment number<br/>- Scheduled date/time<br/>- Deposit: 200,000 VND
        Email-->>-Customer: confirmationEmail

        AppSvc->>+DB: SELECT Appointment<br/>WITH populate(vehicle)
        DB-->>-AppSvc: Appointment

        AppSvc-->>-UI: appointment
        UI-->>-Customer: showConfirmation()

    %% ============================================================================
    %% ALT: Payment Failed
    %% ============================================================================

    else [vnp_ResponseCode != "00"] Payment Failed
        Customer->>+Gateway: submitPayment()
        Gateway->>+VNPay: callback(failed)

        Note right of VNPay: verifyReturnUrl()<br/>validate SecureHash
        VNPay->>VNPay: verifyReturnUrl()

        VNPay->>+DB: SELECT Transaction
        DB-->>-VNPay: Transaction

        VNPay->>+TxSvc: updateStatus(failed)
        TxSvc->>+DB: UPDATE Transaction<br/>SET status = "failed"<br/>SET errorCode
        DB-->>-TxSvc: OK
        TxSvc-->>-VNPay: Transaction

        VNPay-->>-Gateway: redirect(failed)
        Gateway-->>-Customer: paymentFailed

        Customer->>+UI: viewError()
        Note right of UI: Customer có thể:<br/>- Retry payment<br/>- Cancel booking<br/>- Contact support
        UI-->>-Customer: showError()
    end
