<mxfile host="app.diagrams.net" modified="2025-01-06T00:00:00.000Z" agent="Claude Code" version="24.0.0" type="device">
  <diagram name="Cancellation and Refund Flow" id="cancel-refund-diagram">
    <mxGraphModel dx="1434" dy="844" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="2400" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="Appointment Cancellation and Refund Flow&#xa;EV Service Center Management System" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="400" y="20" width="800" height="40" as="geometry" />
        </mxCell>

        <!-- Lifelines -->
        <!-- Customer -->
        <mxCell id="customer-box" value="Customer" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;outlineConnect=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="80" y="100" width="40" height="80" as="geometry" />
        </mxCell>
        <mxCell id="customer-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="100" y="2350" as="sourcePoint" />
            <mxPoint x="100" y="180" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- UI -->
        <mxCell id="ui-box" value="BookingPage" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="220" y="120" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="ui-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="270" y="2350" as="sourcePoint" />
            <mxPoint x="270" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- AppointmentService -->
        <mxCell id="appsvc-box" value="AppointmentService" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="380" y="120" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="appsvc-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="440" y="2350" as="sourcePoint" />
            <mxPoint x="440" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- TransactionService -->
        <mxCell id="txsvc-box" value="TransactionService" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="560" y="120" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="txsvc-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="620" y="2350" as="sourcePoint" />
            <mxPoint x="620" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Database -->
        <mxCell id="db-box" value="Database" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="740" y="120" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="db-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="790" y="2350" as="sourcePoint" />
            <mxPoint x="790" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Staff -->
        <mxCell id="staff-box" value="Staff" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;outlineConnect=0;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="920" y="100" width="40" height="80" as="geometry" />
        </mxCell>
        <mxCell id="staff-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="940" y="2350" as="sourcePoint" />
            <mxPoint x="940" y="180" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- EmailService -->
        <mxCell id="email-box" value="EmailService" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1060" y="120" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="email-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1110" y="2350" as="sourcePoint" />
            <mxPoint x="1110" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- SlotService -->
        <mxCell id="slot-box" value="SlotService" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1220" y="120" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="slot-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1270" y="2350" as="sourcePoint" />
            <mxPoint x="1270" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Use Case Note -->
        <mxCell id="usecase-note" value="Use Case: Customer yêu cầu hủy appointment và nhận hoàn tiền&#xa;Pre-condition: Appointment đã được tạo với trạng thái hợp lệ (confirmed/scheduled)&#xa;Post-condition: Appointment bị hủy, cọc/tiền được hoàn lại cho customer&#xa;Business Rule: Hoàn 100% nếu hủy &gt;24h trước lịch hẹn, 50% nếu &lt;24h" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;size=10;" vertex="1" parent="1">
          <mxGeometry x="80" y="220" width="1240" height="60" as="geometry" />
        </mxCell>

        <!-- PHASE 1: Customer Request Cancellation -->
        <mxCell id="phase1-label" value="PHASE 1: CUSTOMER YÊU CẦU HỦY APPOINTMENT" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#0066CC;" vertex="1" parent="1">
          <mxGeometry x="80" y="300" width="1240" height="20" as="geometry" />
        </mxCell>

        <!-- Message 1: viewAppointment -->
        <mxCell id="msg1" value="viewAppointment()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.4118" y="20" relative="1" as="geometry">
            <mxPoint x="100" y="340" as="sourcePoint" />
            <mxPoint x="270" y="340" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for UI -->
        <mxCell id="ui-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="265" y="340" width="10" height="80" as="geometry" />
        </mxCell>

        <!-- Message 2: clickCancelButton -->
        <mxCell id="msg2" value="clickCancelButton()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.4118" y="20" relative="1" as="geometry">
            <mxPoint x="100" y="380" as="sourcePoint" />
            <mxPoint x="270" y="380" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Return: showCancellationForm -->
        <mxCell id="msg3" value="showCancellationForm()" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.4118" y="-20" relative="1" as="geometry">
            <mxPoint x="270" y="410" as="sourcePoint" />
            <mxPoint x="100" y="410" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 4: submitCancellationRequest -->
        <mxCell id="msg4" value="submitCancellationRequest(reason, refundMethod)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.4118" y="20" relative="1" as="geometry">
            <mxPoint x="100" y="450" as="sourcePoint" />
            <mxPoint x="270" y="450" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for UI (submitCancellation) -->
        <mxCell id="ui-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="265" y="450" width="10" height="360" as="geometry" />
        </mxCell>

        <!-- Cancellation Form Note -->
        <mxCell id="cancel-form-note" value="Cancellation form:&#xa;- Reason (required)&#xa;- Refund method: cash | bank_transfer&#xa;- Bank info (if bank_transfer):&#xa;  • bankName, accountNumber&#xa;  • accountHolder&#xa;  • bankProofImage" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="90" y="470" width="150" height="110" as="geometry" />
        </mxCell>

        <!-- Message 5: POST /api/appointments/:id/request-cancel -->
        <mxCell id="msg5" value="POST /api/appointments/:id/request-cancel" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2174" y="20" relative="1" as="geometry">
            <mxPoint x="275" y="490" as="sourcePoint" />
            <mxPoint x="440" y="490" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for AppSvc -->
        <mxCell id="appsvc-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="435" y="490" width="10" height="280" as="geometry" />
        </mxCell>

        <!-- Message 6: SELECT Appointment -->
        <mxCell id="msg6" value="SELECT Appointment WHERE _id" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.8286" y="30" relative="1" as="geometry">
            <mxPoint x="445" y="520" as="sourcePoint" />
            <mxPoint x="790" y="520" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for DB -->
        <mxCell id="db-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="785" y="520" width="10" height="40" as="geometry" />
        </mxCell>

        <!-- Return: Appointment -->
        <mxCell id="msg7" value="Appointment" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.025" y="-12" relative="1" as="geometry">
            <mxPoint x="790" y="550" as="sourcePoint" />
            <mxPoint x="440" y="550" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Self-call: validateCancellation -->
        <mxCell id="msg8" value="canBeCancelledByCustomer()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.4751" relative="1" as="geometry">
            <mxPoint x="445" y="580" as="sourcePoint" />
            <mxPoint x="500" y="580" as="targetPoint" />
            <Array as="points">
              <mxPoint x="480" y="580" />
              <mxPoint x="480" y="600" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Validation Note -->
        <mxCell id="validate-note" value="Validation:&#xa;- Customer owns appointment&#xa;- Status: confirmed|scheduled&#xa;- Calculate refund %:&#xa;  • 100% if &gt;24h before&#xa;  • 50% if &lt;24h before&#xa;  • 0% if already started" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="510" y="560" width="160" height="100" as="geometry" />
        </mxCell>

        <!-- Self-call: requestCancellation -->
        <mxCell id="msg9" value="requestCancellation(reason, refundInfo)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.4751" relative="1" as="geometry">
            <mxPoint x="445" y="630" as="sourcePoint" />
            <mxPoint x="500" y="630" as="targetPoint" />
            <Array as="points">
              <mxPoint x="480" y="630" />
              <mxPoint x="480" y="650" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 10: UPDATE Appointment -->
        <mxCell id="msg10" value="UPDATE Appointment SET status='cancel_requested'" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.6232" y="20" relative="1" as="geometry">
            <mxPoint x="445" y="680" as="sourcePoint" />
            <mxPoint x="790" y="680" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for DB -->
        <mxCell id="db-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="785" y="680" width="10" height="40" as="geometry" />
        </mxCell>

        <!-- Cancel Request Note -->
        <mxCell id="cancel-req-note" value="cancelRequest:&#xa;- requestedBy: customerId&#xa;- requestedAt: now()&#xa;- reason: string&#xa;- refundPercentage: 100|50&#xa;- refundMethod: cash|bank_transfer&#xa;- customerBankInfo (if bank_transfer)" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="680" y="650" width="200" height="100" as="geometry" />
        </mxCell>

        <!-- Return: OK -->
        <mxCell id="msg11" value="OK" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.2089" relative="1" as="geometry">
            <mxPoint x="790" y="710" as="sourcePoint" />
            <mxPoint x="440" y="710" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Return: success response -->
        <mxCell id="msg12" value="{success, refundPercentage, message}" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.4857" relative="1" as="geometry">
            <mxPoint x="440" y="760" as="sourcePoint" />
            <mxPoint x="270" y="760" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Return: showCancelRequestSuccess -->
        <mxCell id="msg13" value="showCancelRequestSuccess()" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.4118" y="-20" relative="1" as="geometry">
            <mxPoint x="270" y="800" as="sourcePoint" />
            <mxPoint x="100" y="800" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- PHASE 2: Staff Approve Cancellation -->
        <mxCell id="phase2-label" value="PHASE 2: STAFF DUYỆT YÊU CẦU HỦY" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#0066CC;" vertex="1" parent="1">
          <mxGeometry x="80" y="840" width="1240" height="20" as="geometry" />
        </mxCell>

        <!-- Message 14: viewCancelRequests -->
        <mxCell id="msg14" value="viewCancelRequests()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="940" y="880" as="sourcePoint" />
            <mxPoint x="270" y="880" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for UI (staff) -->
        <mxCell id="ui-act3" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="265" y="880" width="10" height="400" as="geometry" />
        </mxCell>

        <!-- Message 15: GET /api/appointments?status=cancel_requested -->
        <mxCell id="msg15" value="GET /api/appointments?status=cancel_requested" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="275" y="910" as="sourcePoint" />
            <mxPoint x="440" y="910" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for AppSvc (list) -->
        <mxCell id="appsvc-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="435" y="910" width="10" height="60" as="geometry" />
        </mxCell>

        <!-- Return: List of cancel requests -->
        <mxCell id="msg16" value="[Appointments with cancel_requested]" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.2548" y="-20" relative="1" as="geometry">
            <mxPoint x="440" y="960" as="sourcePoint" />
            <mxPoint x="270" y="960" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Return: displayCancelRequests -->
        <mxCell id="msg17" value="displayCancelRequests()" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.0455" relative="1" as="geometry">
            <mxPoint x="270" y="990" as="sourcePoint" />
            <mxPoint x="940" y="990" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 18: approveCancellation -->
        <mxCell id="msg18" value="approveCancellation(notes)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="940" y="1030" as="sourcePoint" />
            <mxPoint x="270" y="1030" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 19: POST /api/appointments/:id/approve-cancel -->
        <mxCell id="msg19" value="POST /api/appointments/:id/approve-cancel" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="275" y="1060" as="sourcePoint" />
            <mxPoint x="440" y="1060" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for AppSvc (approve) -->
        <mxCell id="appsvc-act3" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="435" y="1060" width="10" height="180" as="geometry" />
        </mxCell>

        <!-- Self-call: approveCancellation -->
        <mxCell id="msg20" value="approveCancellation(staffId, notes)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="0.1" y="10" relative="1" as="geometry">
            <mxPoint x="445" y="1090" as="sourcePoint" />
            <mxPoint x="500" y="1090" as="targetPoint" />
            <Array as="points">
              <mxPoint x="480" y="1090" />
              <mxPoint x="480" y="1110" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 21: UPDATE Appointment -->
        <mxCell id="msg21" value="UPDATE Appointment SET status='cancel_approved'" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.6232" y="30" relative="1" as="geometry">
            <mxPoint x="445" y="1130" as="sourcePoint" />
            <mxPoint x="790" y="1130" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for DB -->
        <mxCell id="db-act3" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="785" y="1130" width="10" height="40" as="geometry" />
        </mxCell>

        <!-- Return: OK -->
        <mxCell id="msg22" value="OK" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.2447" y="-20" relative="1" as="geometry">
            <mxPoint x="790" y="1160" as="sourcePoint" />
            <mxPoint x="440" y="1160" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 23: releaseSlot -->
        <mxCell id="msg23" value="releaseSlot(slotId)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.7778" y="20" relative="1" as="geometry">
            <mxPoint x="445" y="1190" as="sourcePoint" />
            <mxPoint x="1270" y="1190" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for Slot -->
        <mxCell id="slot-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1265" y="1190" width="10" height="40" as="geometry" />
        </mxCell>

        <!-- Return: Slot released -->
        <mxCell id="msg24" value="OK" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.1549" y="-20" relative="1" as="geometry">
            <mxPoint x="1270" y="1220" as="sourcePoint" />
            <mxPoint x="440" y="1220" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Return: success -->
        <mxCell id="msg25" value="{success, status: 'cancel_approved'}" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.6474" y="-20" relative="1" as="geometry">
            <mxPoint x="440" y="1260" as="sourcePoint" />
            <mxPoint x="940" y="1260" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- PHASE 3: Staff Process Refund -->
        <mxCell id="phase3-label" value="PHASE 3: STAFF XỬ LÝ HOÀN TIỀN" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#0066CC;" vertex="1" parent="1">
          <mxGeometry x="80" y="1300" width="1240" height="20" as="geometry" />
        </mxCell>

        <!-- Message 26: processRefund -->
        <mxCell id="msg26" value="processRefund()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="940" y="1340" as="sourcePoint" />
            <mxPoint x="270" y="1340" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for UI (refund) -->
        <mxCell id="ui-act4" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="265" y="1340" width="10" height="720" as="geometry" />
        </mxCell>

        <!-- Return: showRefundForm -->
        <mxCell id="msg27" value="showRefundForm()" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.0455" y="-20" relative="1" as="geometry">
            <mxPoint x="270" y="1370" as="sourcePoint" />
            <mxPoint x="940" y="1370" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Refund Form Note -->
        <mxCell id="refund-form-note" value="Refund form:&#xa;- Refund proof image (required)&#xa;- Staff notes (optional)" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1020" y="1340" width="180" height="60" as="geometry" />
        </mxCell>

        <!-- Message 28: submitRefund -->
        <mxCell id="msg28" value="submitRefund(refundProofImage, notes)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="940" y="1420" as="sourcePoint" />
            <mxPoint x="270" y="1420" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 29: POST /api/appointments/:id/process-refund -->
        <mxCell id="msg29" value="POST /api/appointments/:id/process-refund" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.2" y="10" relative="1" as="geometry">
            <mxPoint x="275" y="1450" as="sourcePoint" />
            <mxPoint x="440" y="1450" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for AppSvc (refund) -->
        <mxCell id="appsvc-act4" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="435" y="1450" width="10" height="570" as="geometry" />
        </mxCell>

        <!-- Message 30: SELECT Appointment -->
        <mxCell id="msg30" value="SELECT Appointment WHERE _id" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.8286" y="30" relative="1" as="geometry">
            <mxPoint x="445" y="1480" as="sourcePoint" />
            <mxPoint x="790" y="1480" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for DB (get appointment) -->
        <mxCell id="db-act4" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="785" y="1480" width="10" height="40" as="geometry" />
        </mxCell>

        <!-- Return: Appointment -->
        <mxCell id="msg31" value="Appointment" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.025" y="-12" relative="1" as="geometry">
            <mxPoint x="790" y="1510" as="sourcePoint" />
            <mxPoint x="440" y="1510" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Self-call: calculateRefundAmount -->
        <mxCell id="msg32" value="calculateRefundAmount()" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.4751" relative="1" as="geometry">
            <mxPoint x="445" y="1540" as="sourcePoint" />
            <mxPoint x="500" y="1540" as="targetPoint" />
            <Array as="points">
              <mxPoint x="480" y="1540" />
              <mxPoint x="480" y="1560" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Refund Calculation Note -->
        <mxCell id="refund-calc-note" value="Refund calculation:&#xa;- If deposit_booking:&#xa;  baseAmount = depositInfo.amount (200k)&#xa;- If full_service:&#xa;  baseAmount = totalAmount&#xa;&#xa;refundAmount = baseAmount * refundPercentage / 100" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="510" y="1530" width="200" height="100" as="geometry" />
        </mxCell>

        <!-- ALT Frame: Cash vs Bank Transfer -->
        <mxCell id="alt-frame" value="alt" style="shape=rect;html=1;whiteSpace=wrap;align=left;verticalAlign=top;fillColor=none;strokeColor=#666666;strokeWidth=1;dashed=1;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="420" y="1590" width="400" height="320" as="geometry" />
        </mxCell>

        <!-- ALT Condition 1: Cash -->
        <mxCell id="alt-cond1" value="[Refund method: cash]" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;fontStyle=2;" vertex="1" parent="1">
          <mxGeometry x="430" y="1600" width="160" height="20" as="geometry" />
        </mxCell>

        <!-- Message 33: createTransaction (cash) -->
        <mxCell id="msg33" value="createTransaction(cash, transactionData)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.4" y="20" relative="1" as="geometry">
            <mxPoint x="445" y="1630" as="sourcePoint" />
            <mxPoint x="620" y="1630" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for TxSvc (cash) -->
        <mxCell id="txsvc-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="615" y="1630" width="10" height="100" as="geometry" />
        </mxCell>

        <!-- Cash Transaction Note -->
        <mxCell id="cash-tx-note" value="Cash transaction:&#xa;- paymentPurpose: 'refund'&#xa;- amount: refundAmount&#xa;- cashData: {&#xa;    receivedBy: staffId,&#xa;    receiptNumber: REFUND_CASH_xxx,&#xa;    receiptImage: refundProofImage&#xa;  }" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="660" y="1610" width="200" height="100" as="geometry" />
        </mxCell>

        <!-- Message 34: INSERT Transaction (cash) -->
        <mxCell id="msg34" value="INSERT Transaction" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.7" y="20" relative="1" as="geometry">
            <mxPoint x="625" y="1660" as="sourcePoint" />
            <mxPoint x="790" y="1660" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for DB (cash tx) -->
        <mxCell id="db-act5" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="785" y="1660" width="10" height="30" as="geometry" />
        </mxCell>

        <!-- Return: transactionId (cash) -->
        <mxCell id="msg35" value="transactionId" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.15" y="-12" relative="1" as="geometry">
            <mxPoint x="790" y="1685" as="sourcePoint" />
            <mxPoint x="620" y="1685" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Self-call: updateStatus (cash) -->
        <mxCell id="msg36" value="updateStatus(completed)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.3" relative="1" as="geometry">
            <mxPoint x="625" y="1710" as="sourcePoint" />
            <mxPoint x="670" y="1710" as="targetPoint" />
            <Array as="points">
              <mxPoint x="655" y="1710" />
              <mxPoint x="655" y="1720" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Return: Transaction (cash) -->
        <mxCell id="msg37" value="Transaction" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.3" y="-12" relative="1" as="geometry">
            <mxPoint x="620" y="1740" as="sourcePoint" />
            <mxPoint x="440" y="1740" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- ALT Divider Line -->
        <mxCell id="alt-divider" value="" style="endArrow=none;html=1;strokeWidth=1;strokeColor=#666666;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="420" y="1760" as="sourcePoint" />
            <mxPoint x="820" y="1760" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- ALT Condition 2: Bank Transfer -->
        <mxCell id="alt-cond2" value="[Refund method: bank_transfer]" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;fontStyle=2;" vertex="1" parent="1">
          <mxGeometry x="430" y="1770" width="180" height="20" as="geometry" />
        </mxCell>

        <!-- Message 38: createTransaction (bank) -->
        <mxCell id="msg38" value="createTransaction(bank_transfer, transactionData)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.4" y="20" relative="1" as="geometry">
            <mxPoint x="445" y="1800" as="sourcePoint" />
            <mxPoint x="620" y="1800" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for TxSvc (bank) -->
        <mxCell id="txsvc-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="615" y="1800" width="10" height="100" as="geometry" />
        </mxCell>

        <!-- Bank Transfer Transaction Note -->
        <mxCell id="bank-tx-note" value="Bank transfer transaction:&#xa;- paymentPurpose: 'refund'&#xa;- amount: refundAmount&#xa;- bankTransferData: {&#xa;    bankName, accountNumber,&#xa;    accountHolder,&#xa;    transferRef: REFUND_TRF_xxx,&#xa;    receiptImage: refundProofImage&#xa;  }" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="660" y="1780" width="200" height="110" as="geometry" />
        </mxCell>

        <!-- Message 39: INSERT Transaction (bank) -->
        <mxCell id="msg39" value="INSERT Transaction" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.7" y="20" relative="1" as="geometry">
            <mxPoint x="625" y="1830" as="sourcePoint" />
            <mxPoint x="790" y="1830" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for DB (bank tx) -->
        <mxCell id="db-act6" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="785" y="1830" width="10" height="30" as="geometry" />
        </mxCell>

        <!-- Return: transactionId (bank) -->
        <mxCell id="msg40" value="transactionId" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.15" y="-12" relative="1" as="geometry">
            <mxPoint x="790" y="1855" as="sourcePoint" />
            <mxPoint x="620" y="1855" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Self-call: updateStatus (bank) -->
        <mxCell id="msg41" value="updateStatus(completed)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.3" relative="1" as="geometry">
            <mxPoint x="625" y="1880" as="sourcePoint" />
            <mxPoint x="670" y="1880" as="targetPoint" />
            <Array as="points">
              <mxPoint x="655" y="1880" />
              <mxPoint x="655" y="1890" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Return: Transaction (bank) -->
        <mxCell id="msg42" value="Transaction" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.3" y="-12" relative="1" as="geometry">
            <mxPoint x="620" y="1910" as="sourcePoint" />
            <mxPoint x="440" y="1910" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Self-call: processRefund -->
        <mxCell id="msg43" value="processRefund(staffId, transactionId)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.4751" relative="1" as="geometry">
            <mxPoint x="445" y="1940" as="sourcePoint" />
            <mxPoint x="500" y="1940" as="targetPoint" />
            <Array as="points">
              <mxPoint x="480" y="1940" />
              <mxPoint x="480" y="1960" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Message 44: UPDATE Appointment (refunded) -->
        <mxCell id="msg44" value="UPDATE Appointment SET status='refunded'" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.6232" y="20" relative="1" as="geometry">
            <mxPoint x="445" y="1980" as="sourcePoint" />
            <mxPoint x="790" y="1980" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for DB (refunded status) -->
        <mxCell id="db-act7" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="785" y="1980" width="10" height="40" as="geometry" />
        </mxCell>

        <!-- Refund Info Note -->
        <mxCell id="refund-info-note" value="Refund info:&#xa;- refundedBy: staffId&#xa;- refundedAt: now()&#xa;- refundTransactionId: transactionId&#xa;- refundProofImage: image&#xa;- refundNotes: notes" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="680" y="1950" width="180" height="90" as="geometry" />
        </mxCell>

        <!-- Return: OK -->
        <mxCell id="msg45" value="OK" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.2089" relative="1" as="geometry">
            <mxPoint x="790" y="2010" as="sourcePoint" />
            <mxPoint x="440" y="2010" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- PAR Frame: Email Notification -->
        <mxCell id="par-frame" value="par [Send refund notification email]" style="shape=rect;html=1;whiteSpace=wrap;align=left;verticalAlign=top;fillColor=none;strokeColor=#666666;strokeWidth=1;dashed=1;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="420" y="2020" width="720" height="60" as="geometry" />
        </mxCell>

        <!-- Message 46: sendRefundNotification -->
        <mxCell id="msg46" value="sendRefundNotification(refundData)" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.5" y="20" relative="1" as="geometry">
            <mxPoint x="445" y="2040" as="sourcePoint" />
            <mxPoint x="1110" y="2040" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Activation bar for Email -->
        <mxCell id="email-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1105" y="2040" width="10" height="30" as="geometry" />
        </mxCell>

        <!-- Email Content Note -->
        <mxCell id="email-note" value="Email content:&#xa;- Appointment number&#xa;- Refund amount: XXX,XXX VND&#xa;- Refund percentage: 100%|50%&#xa;- Refund method: cash|bank_transfer&#xa;- Transaction reference" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#fff9e6;strokeColor=#d6b656;align=left;size=8;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1150" y="2020" width="200" height="90" as="geometry" />
        </mxCell>

        <!-- Message 47: refundNotificationEmail -->
        <mxCell id="msg47" value="refundNotificationEmail" style="endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry x="-0.8" y="20" relative="1" as="geometry">
            <mxPoint x="1110" y="2060" as="sourcePoint" />
            <mxPoint x="100" y="2060" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Return: success response -->
        <mxCell id="msg48" value="{success, refundAmount, transactionRef}" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="0.4857" y="-20" relative="1" as="geometry">
            <mxPoint x="440" y="2020" as="sourcePoint" />
            <mxPoint x="270" y="2020" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Return: showRefundSuccess -->
        <mxCell id="msg49" value="showRefundSuccess()" style="endArrow=open;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry x="-0.0455" y="-20" relative="1" as="geometry">
            <mxPoint x="270" y="2050" as="sourcePoint" />
            <mxPoint x="940" y="2050" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Refund Complete Note -->
        <mxCell id="refund-complete-note" value="Business Rules:&#xa;1. Refund amount = baseAmount * refundPercentage&#xa;2. baseAmount: depositInfo.amount (deposit_booking) OR totalAmount (full_service)&#xa;3. Refund methods: cash (at counter) | bank_transfer (with proof)&#xa;4. Transaction created with status 'completed'&#xa;5. Email notification sent to customer&#xa;&#xa;Status Flow: cancel_requested → cancel_approved → refunded" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;size=10;" vertex="1" parent="1">
          <mxGeometry x="80" y="2100" width="1240" height="120" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
